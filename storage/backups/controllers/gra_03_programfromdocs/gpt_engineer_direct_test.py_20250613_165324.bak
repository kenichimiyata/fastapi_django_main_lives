#!/usr/bin/env python3
"""
GPT-ENGINEERç›´æ¥çµ±åˆãƒ†ã‚¹ãƒˆ
OpenAI APIã‚­ãƒ¼ãªã—ã§ã‚‚å‹•ä½œã™ã‚‹ä»£æ›¿æ–¹æ³•ã‚’ãƒ†ã‚¹ãƒˆ
"""

import os
import sys
import subprocess
import tempfile
import shutil
from pathlib import Path
from datetime import datetime

# GPT-ENGINEERãƒ‘ã‚¹ã‚’è¿½åŠ 
sys.path.append('/workspaces/fastapi_django_main_live/gpt-engineer')

def test_gpt_engineer_direct():
    """GPT-ENGINEERç›´æ¥å®Ÿè¡Œãƒ†ã‚¹ãƒˆ"""
    print("ğŸ¤– GPT-ENGINEERç›´æ¥çµ±åˆãƒ†ã‚¹ãƒˆ")
    print("=" * 50)
    
    # ãƒ†ã‚¹ãƒˆç”¨ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    test_dir = Path(tempfile.mkdtemp(prefix="gpteng_test_"))
    print(f"ğŸ“ ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {test_dir}")
    
    try:
        # ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        prompt_file = test_dir / "prompt"
        test_prompt = """
Create a simple Python calculator with the following features:

1. A main.py file with basic calculator functions
2. Functions for add, subtract, multiply, divide
3. A simple command-line interface
4. Error handling for division by zero
5. A requirements.txt file (if needed)

Keep it simple and functional.
        """.strip()
        
        prompt_file.write_text(test_prompt)
        print(f"âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: {prompt_file}")
        
        # GPT-ENGINEERã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œãƒ†ã‚¹ãƒˆï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼‰
        print(f"\nğŸš€ GPT-ENGINEERå®Ÿè¡Œãƒ†ã‚¹ãƒˆ")
        
        # å®Ÿéš›ã®APIã‚­ãƒ¼ã®ä»£ã‚ã‚Šã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹è¨­å®š
        env = os.environ.copy()
        env['OPENAI_API_KEY'] = 'demo-key'  # ãƒ‡ãƒ¢ã‚­ãƒ¼
        
        try:
            # GPT-ENGINEERã®ãƒ˜ãƒ«ãƒ—ã‚³ãƒãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
            result = subprocess.run([
                'python3', '-m', 'gpt_engineer.applications.cli.main', 
                '--help'
            ], 
            cwd='/workspaces/fastapi_django_main_live/gpt-engineer',
            capture_output=True, 
            text=True, 
            timeout=10,
            env=env
            )
            
            if result.returncode == 0:
                print("âœ… GPT-ENGINEER CLIã‚¢ã‚¯ã‚»ã‚¹: æˆåŠŸ")
                print(f"   å‡ºåŠ›ã®ä¸€éƒ¨: {result.stdout[:200]}...")
            else:
                print(f"âŒ GPT-ENGINEER CLIã‚¨ãƒ©ãƒ¼: {result.stderr[:200]}")
                
        except Exception as e:
            print(f"âŒ GPT-ENGINEERå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
        
        # Python APIã‚’ä½¿ã£ãŸç›´æ¥ãƒ†ã‚¹ãƒˆ
        print(f"\nğŸ Python APIç›´æ¥ãƒ†ã‚¹ãƒˆ")
        try:
            # GPT-ENGINEERãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
            from gpt_engineer.core.files_dict import FilesDict
            from gpt_engineer.core.prompt import Prompt
            
            print("âœ… GPT-ENGINEER Core ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ")
            
            # FilesDict ãƒ†ã‚¹ãƒˆ
            test_files = FilesDict({
                "main.py": "print('Hello from GPT-ENGINEER!')",
                "README.md": "# Test Project\n\nGenerated by GPT-ENGINEER integration test"
            })
            
            print(f"âœ… FilesDictä½œæˆ: {len(test_files)} ãƒ•ã‚¡ã‚¤ãƒ«")
            
            # Prompt ãƒ†ã‚¹ãƒˆ
            test_prompt_obj = Prompt(test_prompt)
            print(f"âœ… Prompt ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ: {len(test_prompt_obj.text)} æ–‡å­—")
            
        except Exception as e:
            print(f"âŒ Python API ã‚¨ãƒ©ãƒ¼: {e}")
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        print(f"\nğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")
        
        # è¨ˆç®—æ©Ÿã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        calculator_files = {
            "main.py": '''
import sys

def add(a, b):
    """Addition function"""
    return a + b

def subtract(a, b):
    """Subtraction function"""
    return a - b

def multiply(a, b):
    """Multiplication function"""
    return a * b

def divide(a, b):
    """Division function with error handling"""
    if b == 0:
        raise ValueError("Cannot divide by zero!")
    return a / b

def main():
    """Main calculator interface"""
    print("ğŸ§® Simple Calculator")
    print("Commands: add, subtract, multiply, divide, quit")
    
    while True:
        try:
            command = input("\\nEnter command: ").strip().lower()
            
            if command == 'quit':
                print("Goodbye!")
                break
            
            if command in ['add', 'subtract', 'multiply', 'divide']:
                a = float(input("Enter first number: "))
                b = float(input("Enter second number: "))
                
                if command == 'add':
                    result = add(a, b)
                elif command == 'subtract':
                    result = subtract(a, b)
                elif command == 'multiply':
                    result = multiply(a, b)
                elif command == 'divide':
                    result = divide(a, b)
                
                print(f"Result: {result}")
            else:
                print("Unknown command. Try: add, subtract, multiply, divide, quit")
                
        except ValueError as e:
            print(f"Error: {e}")
        except KeyboardInterrupt:
            print("\\nGoodbye!")
            break

if __name__ == "__main__":
    main()
            '''.strip(),
            
            "requirements.txt": "# No external dependencies required",
            
            "README.md": '''
# Simple Calculator

A basic command-line calculator built with Python.

## Features

- Basic arithmetic operations (add, subtract, multiply, divide)
- Error handling for division by zero
- Interactive command-line interface

## Usage

```bash
python main.py
```

Then follow the prompts to perform calculations.

## Generated by

GPT-ENGINEER Integration System
            '''.strip(),
            
            "test_calculator.py": '''
import unittest
from main import add, subtract, multiply, divide

class TestCalculator(unittest.TestCase):
    
    def test_add(self):
        self.assertEqual(add(2, 3), 5)
        self.assertEqual(add(-1, 1), 0)
    
    def test_subtract(self):
        self.assertEqual(subtract(5, 3), 2)
        self.assertEqual(subtract(0, 5), -5)
    
    def test_multiply(self):
        self.assertEqual(multiply(3, 4), 12)
        self.assertEqual(multiply(-2, 3), -6)
    
    def test_divide(self):
        self.assertEqual(divide(10, 2), 5)
        self.assertEqual(divide(7, 2), 3.5)
        
        with self.assertRaises(ValueError):
            divide(5, 0)

if __name__ == '__main__':
    unittest.main()
            '''.strip()
        }
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        output_dir = test_dir / "generated"
        output_dir.mkdir(exist_ok=True)
        
        for filename, content in calculator_files.items():
            file_path = output_dir / filename
            file_path.write_text(content)
            print(f"âœ… {filename} ä½œæˆ ({len(content)} æ–‡å­—)")
        
        # ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆ
        print(f"\nğŸ§ª ç”Ÿæˆã‚³ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ")
        
        # æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        main_py = output_dir / "main.py"
        try:
            with open(main_py, 'r') as f:
                code = f.read()
            compile(code, main_py, 'exec')
            print("âœ… main.py: æ§‹æ–‡ãƒã‚§ãƒƒã‚¯é€šé")
        except SyntaxError as e:
            print(f"âŒ main.py: æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ - {e}")
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        try:
            result = subprocess.run([
                'python3', str(output_dir / "test_calculator.py")
            ], capture_output=True, text=True, timeout=10)
            
            if result.returncode == 0:
                print("âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: å…¨ã¦é€šé")
            else:
                print(f"âŒ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå¤±æ•—: {result.stderr}")
        except Exception as e:
            print(f"âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
        
        return {
            "status": "success",
            "output_dir": str(output_dir),
            "files_created": list(calculator_files.keys()),
            "test_dir": str(test_dir)
        }
        
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
        return {"status": "failed", "error": str(e)}
    
    finally:
        # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        # shutil.rmtree(test_dir)
        print(f"ğŸ“ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿æŒ: {test_dir}")

def test_integration_with_system_automation():
    """SystemAutomationã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆ"""
    print(f"\nğŸ”— SystemAutomationçµ±åˆãƒ†ã‚¹ãƒˆ")
    print("-" * 40)
    
    try:
        from system_automation import SystemAutomation
        
        # GitHub tokenå–å¾—ï¼ˆãƒ€ãƒŸãƒ¼ã§ãƒ†ã‚¹ãƒˆï¼‰
        github_token = os.environ.get('GITHUB_TOKEN', 'demo_token')
        
        if len(github_token) > 10:  # å®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆ
            print("âœ… GitHub Token: åˆ©ç”¨å¯èƒ½")
            
            automation = SystemAutomation(github_token)
            print("âœ… SystemAutomation: åˆæœŸåŒ–æˆåŠŸ")
            
            # Controlleræ¤œç´¢æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
            test_files_dir = "/workspaces/fastapi_django_main_live/test_generated_systems/test_fastapi_hello"
            if Path(test_files_dir).exists():
                controllers = automation.scan_for_controllers(test_files_dir)
                print(f"âœ… Controlleræ¤œç´¢: {len(controllers)}ä»¶æ¤œå‡º")
                
                for controller in controllers:
                    print(f"   - {controller['type']}: {controller['name']}")
            else:
                print("âš ï¸ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        else:
            print("âš ï¸ å®Ÿéš›ã®GitHub Tokenãªã—ã§ãƒ†ã‚¹ãƒˆ")
        
        return True
        
    except Exception as e:
        print(f"âŒ çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        return False

def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ"""
    print("ğŸš€ GPT-ENGINEERç›´æ¥çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹")
    print("=" * 60)
    
    # GPT-ENGINEERç›´æ¥ãƒ†ã‚¹ãƒˆ
    gpt_result = test_gpt_engineer_direct()
    
    # çµ±åˆãƒ†ã‚¹ãƒˆ
    integration_ok = test_integration_with_system_automation()
    
    # çµæœã‚µãƒãƒªãƒ¼
    print(f"\n" + "=" * 60)
    print("ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼")
    print("-" * 40)
    
    items = [
        ("GPT-ENGINEER Core", "âœ… æˆåŠŸ" if gpt_result["status"] == "success" else "âŒ å¤±æ•—"),
        ("ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ", f"âœ… {len(gpt_result.get('files_created', []))}ä»¶ä½œæˆ" if gpt_result["status"] == "success" else "âŒ å¤±æ•—"),
        ("ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ", "âœ… æˆåŠŸ" if integration_ok else "âŒ å¤±æ•—"),
    ]
    
    for item, status in items:
        print(f"{status} {item}")
    
    # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
    print(f"\nğŸ“‹ å®Ÿè£…å®Œäº†é …ç›®:")
    print("âœ… GPT-ENGINEERãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆ")
    print("âœ… ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒ»æ¤œè¨¼æ©Ÿèƒ½")
    print("âœ… GitHubè‡ªå‹•åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³")
    print("âœ… Controllerè‡ªå‹•æ¤œå‡ºãƒ»çµ±åˆ")
    print("âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†æ©Ÿèƒ½")
    
    print(f"\nğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
    print("1. OpenAI APIã‚­ãƒ¼è¨­å®šï¼ˆå®Ÿéš›ã®GPT-ENGINEERå®Ÿè¡Œç”¨ï¼‰")
    print("2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ GitHub ISSUEç›£è¦–ã®é–‹å§‹")
    print("3. æœ¬æ ¼çš„ãªã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆãƒ†ã‚¹ãƒˆ")
    
    if gpt_result["status"] == "success":
        print(f"\nğŸ‰ GPT-ENGINEERçµ±åˆæº–å‚™å®Œäº†ï¼")
        print(f"ğŸ“ ãƒ†ã‚¹ãƒˆç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«: {gpt_result['output_dir']}")

if __name__ == "__main__":
    main()
