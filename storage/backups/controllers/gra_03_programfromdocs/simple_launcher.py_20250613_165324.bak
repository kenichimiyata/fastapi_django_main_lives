#!/usr/bin/env python3
"""
ã‚·ãƒ³ãƒ—ãƒ«çµ±åˆã‚·ã‚¹ãƒ†ãƒ ãƒ©ãƒ³ãƒãƒ£ãƒ¼
å¤–éƒ¨ä¾å­˜é–¢ä¿‚ã‚’æœ€å°åŒ–ã—ãŸã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç‰ˆ
"""

import gradio as gr
import sqlite3
import os
import json
from datetime import datetime
from typing import List, Dict, Optional
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))
from config.database import get_db_path

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
def init_db():
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–"""
    db_path = get_db_path('prompts.db')
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS prompts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL,
            content TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # æ‰¿èªã‚­ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS approval_queue (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL,
            content TEXT NOT NULL,
            source TEXT DEFAULT 'manual',
            priority INTEGER DEFAULT 3,
            status TEXT DEFAULT 'pending',
            github_issue_url TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # å®Ÿè¡Œãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS execution_log (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL,
            status TEXT NOT NULL,
            result_url TEXT,
            execution_time REAL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            details TEXT
        )
    ''')
    
    conn.commit()
    conn.close()

def get_prompts() -> List[Dict]:
    """ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€è¦§å–å¾—"""
    conn = sqlite3.connect('prompts.db')
    cursor = conn.cursor()
    cursor.execute('SELECT id, title, content, created_at FROM prompts ORDER BY id DESC')
    prompts = cursor.fetchall()
    conn.close()
    
    return [
        {
            'id': p[0],
            'title': p[1],
            'content': p[2],
            'created_at': p[3]
        }
        for p in prompts
    ]

def save_prompt(title: str, content: str) -> str:
    """ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜"""
    if not title or not content:
        return "âŒ ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
    
    conn = sqlite3.connect('prompts.db')
    cursor = conn.cursor()
    cursor.execute(
        'INSERT INTO prompts (title, content) VALUES (?, ?)',
        (title, content)
    )
    conn.commit()
    conn.close()
    
    return f"âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ '{title}' ã‚’ä¿å­˜ã—ã¾ã—ãŸ"

def get_approval_queue() -> List[Dict]:
    """æ‰¿èªå¾…ã¡ã‚­ãƒ¥ãƒ¼å–å¾—"""
    conn = sqlite3.connect('prompts.db')
    cursor = conn.cursor()
    cursor.execute('''
        SELECT id, issue_title, issue_body, requester, priority, approval_status, github_repo, created_at 
        FROM approval_queue 
        ORDER BY priority ASC, created_at ASC
    ''')
    queue = cursor.fetchall()
    conn.close()
    
    return [
        {
            'id': q[0],
            'title': q[1],
            'content': q[2],
            'source': q[3],
            'priority': q[4],
            'status': q[5],
            'github_issue_url': q[6] or '',
            'created_at': q[7]
        }
        for q in queue
    ]

def approve_request(request_id: int) -> str:
    """ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èª"""
    conn = sqlite3.connect('prompts.db')
    cursor = conn.cursor()
    
    # ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±å–å¾—
    cursor.execute('SELECT issue_title, issue_body FROM approval_queue WHERE id = ?', (request_id,))
    request = cursor.fetchone()
    
    if not request:
        conn.close()
        return "âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    
    title, content = request
    
    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    cursor.execute(
        'UPDATE approval_queue SET approval_status = ? WHERE id = ?',
        ('approved', request_id)
    )
    
    # å®Ÿè¡Œãƒ­ã‚°ã«è¨˜éŒ²
    cursor.execute(
        'INSERT INTO execution_log (title, status, details) VALUES (?, ?, ?)',
        (title, 'simulated', f'æ‰¿èªã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {content[:100]}...')
    )
    
    conn.commit()
    conn.close()
    
    return f"âœ… '{title}' ã‚’æ‰¿èªã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã—ã¾ã—ãŸ"

def reject_request(request_id: int, reason: str = "") -> str:
    """ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‹’å¦"""
    conn = sqlite3.connect('prompts.db')
    cursor = conn.cursor()
    
    cursor.execute(
        'UPDATE approval_queue SET approval_status = ? WHERE id = ?',
        ('rejected', request_id)
    )
    
    conn.commit()
    conn.close()
    
    return f"âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚ç†ç”±: {reason or 'æœªæŒ‡å®š'}"

def add_to_approval_queue(title: str, content: str, source: str = "manual") -> str:
    """æ‰¿èªã‚­ãƒ¥ãƒ¼ã«è¿½åŠ """
    if not title or not content:
        return "âŒ ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
    
    conn = sqlite3.connect('prompts.db')
    cursor = conn.cursor()
    cursor.execute(
        'INSERT INTO approval_queue (issue_title, issue_body, requester) VALUES (?, ?, ?)',
        (title, content, source)
    )
    conn.commit()
    conn.close()
    
    return f"âœ… '{title}' ã‚’æ‰¿èªã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸ"

def get_execution_logs() -> List[Dict]:
    """å®Ÿè¡Œãƒ­ã‚°å–å¾—"""
    conn = sqlite3.connect('prompts.db')
    cursor = conn.cursor()
    cursor.execute('''
        SELECT id, title, status, result_url, execution_time, created_at, details 
        FROM execution_log 
        ORDER BY created_at DESC 
        LIMIT 50
    ''')
    logs = cursor.fetchall()
    conn.close()
    
    return [
        {
            'id': l[0],
            'title': l[1],
            'status': l[2],
            'result_url': l[3] or '',
            'execution_time': l[4] or 0,
            'created_at': l[5],
            'details': l[6] or ''
        }
        for l in logs
    ]

def create_interface():
    """Gradioã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä½œæˆ"""
    
    init_db()
    
    with gr.Blocks(title="ğŸš€ çµ±åˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ", theme="soft") as interface:
        gr.Markdown("""
        # ğŸš€ çµ±åˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ)
        
        **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç† â†’ æ‰¿èªã‚·ã‚¹ãƒ†ãƒ  â†’ å®Ÿè¡Œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
        
        ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ï¼š
        
        1. **ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†** - ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜ãƒ»ç®¡ç†
        2. **âœ… æ‰¿èªã‚·ã‚¹ãƒ†ãƒ ** - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿè¡Œã®æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
        3. **ğŸ“Š å®Ÿè¡Œç›£è¦–** - ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡ŒçŠ¶æ³ã®ç›£è¦–
        4. **ğŸ”— GitHubé€£æºæº–å‚™** - å°†æ¥çš„ãªGitHubçµ±åˆã¸ã®æº–å‚™
        
        ---
        """)
        
        with gr.Tabs():
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚¿ãƒ–
            with gr.TabItem("ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†"):
                with gr.Row():
                    with gr.Column():
                        prompt_title = gr.Textbox(label="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¿ã‚¤ãƒˆãƒ«", placeholder="ä¾‹: FastAPI + Vue.js ã‚·ã‚¹ãƒ†ãƒ ")
                        prompt_content = gr.Textbox(
                            label="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹",
                            lines=10,
                            placeholder="ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆã«å¿…è¦ãªè©³ç´°è¦ä»¶ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„..."
                        )
                        save_btn = gr.Button("ğŸ’¾ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜", variant="primary")
                        save_result = gr.Textbox(label="ä¿å­˜çµæœ", interactive=False)
                    
                    with gr.Column():
                        gr.Markdown("### ğŸ“‹ ä¿å­˜æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ")
                        prompts_display = gr.Dataframe(
                            headers=["ID", "ã‚¿ã‚¤ãƒˆãƒ«", "ä½œæˆæ—¥æ™‚"],
                            interactive=False
                        )
                        refresh_prompts_btn = gr.Button("ğŸ”„ æ›´æ–°")
                
                def refresh_prompts():
                    prompts = get_prompts()
                    return [[p['id'], p['title'], p['created_at']] for p in prompts]
                
                def save_prompt_wrapper(title, content):
                    result = save_prompt(title, content)
                    return result, "", "", refresh_prompts()
                
                save_btn.click(
                    save_prompt_wrapper,
                    inputs=[prompt_title, prompt_content],
                    outputs=[save_result, prompt_title, prompt_content, prompts_display]
                )
                
                refresh_prompts_btn.click(refresh_prompts, outputs=[prompts_display])
                
                # åˆæœŸè¡¨ç¤º
                interface.load(refresh_prompts, outputs=[prompts_display])
            
            # æ‰¿èªã‚·ã‚¹ãƒ†ãƒ ã‚¿ãƒ–
            with gr.TabItem("âœ… æ‰¿èªã‚·ã‚¹ãƒ†ãƒ "):
                with gr.Row():
                    with gr.Column():
                        gr.Markdown("### ğŸ“¤ æ–°è¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡")
                        req_title = gr.Textbox(label="ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒˆãƒ«")
                        req_content = gr.Textbox(label="ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹", lines=5)
                        submit_btn = gr.Button("ğŸ“¨ æ‰¿èªä¾é ¼é€ä¿¡", variant="secondary")
                        submit_result = gr.Textbox(label="é€ä¿¡çµæœ", interactive=False)
                    
                    with gr.Column():
                        gr.Markdown("### â³ æ‰¿èªå¾…ã¡ã‚­ãƒ¥ãƒ¼")
                        approval_queue = gr.Dataframe(
                            headers=["ID", "ã‚¿ã‚¤ãƒˆãƒ«", "ã‚½ãƒ¼ã‚¹", "å„ªå…ˆåº¦", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"],
                            interactive=False
                        )
                        refresh_queue_btn = gr.Button("ğŸ”„ ã‚­ãƒ¥ãƒ¼æ›´æ–°")
                
                with gr.Row():
                    with gr.Column():
                        gr.Markdown("### ğŸ¯ æ‰¿èªã‚¢ã‚¯ã‚·ãƒ§ãƒ³")
                        action_id = gr.Number(label="å¯¾è±¡ID", precision=0)
                        approve_btn = gr.Button("âœ… æ‰¿èª", variant="primary")
                        reject_btn = gr.Button("âŒ æ‹’å¦", variant="stop")
                        reject_reason = gr.Textbox(label="æ‹’å¦ç†ç”±ï¼ˆä»»æ„ï¼‰")
                        action_result = gr.Textbox(label="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµæœ", interactive=False)
                
                def refresh_queue():
                    queue = get_approval_queue()
                    return [[q['id'], q['title'], q['source'], q['priority'], q['status']] for q in queue if q['status'] == 'pending_review']
                
                def submit_request_wrapper(title, content):
                    result = add_to_approval_queue(title, content)
                    return result, "", "", refresh_queue()
                
                submit_btn.click(
                    submit_request_wrapper,
                    inputs=[req_title, req_content],
                    outputs=[submit_result, req_title, req_content, approval_queue]
                )
                
                approve_btn.click(
                    lambda id_val: approve_request(int(id_val)) if id_val else "âŒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
                    inputs=[action_id],
                    outputs=[action_result]
                )
                
                reject_btn.click(
                    lambda id_val, reason: reject_request(int(id_val), reason) if id_val else "âŒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
                    inputs=[action_id, reject_reason],
                    outputs=[action_result]
                )
                
                refresh_queue_btn.click(refresh_queue, outputs=[approval_queue])
                interface.load(refresh_queue, outputs=[approval_queue])
            
            # å®Ÿè¡Œãƒ­ã‚°ã‚¿ãƒ–
            with gr.TabItem("ğŸ“Š å®Ÿè¡Œãƒ­ã‚°"):
                gr.Markdown("### ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œå±¥æ­´")
                execution_logs = gr.Dataframe(
                    headers=["ID", "ã‚¿ã‚¤ãƒˆãƒ«", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "å®Ÿè¡Œæ™‚é–“", "ä½œæˆæ—¥æ™‚"],
                    interactive=False
                )
                refresh_logs_btn = gr.Button("ğŸ”„ ãƒ­ã‚°æ›´æ–°")
                
                def refresh_logs():
                    logs = get_execution_logs()
                    return [[l['id'], l['title'], l['status'], f"{l['execution_time']:.2f}s", l['created_at']] for l in logs]
                
                refresh_logs_btn.click(refresh_logs, outputs=[execution_logs])
                interface.load(refresh_logs, outputs=[execution_logs])
            
            # ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚¿ãƒ–
            with gr.TabItem("â„¹ï¸ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±"):
                gr.Markdown("""
                ## ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦
                
                ã“ã®çµ±åˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¯ã€GPT-ENGINEERã«ã‚ˆã‚‹è‡ªå‹•ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆã®ãŸã‚ã®
                ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã¨æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æä¾›ã—ã¾ã™ã€‚
                
                ### ğŸ”§ ä¸»è¦æ©Ÿèƒ½
                
                1. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†**
                   - ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜ãƒ»ç·¨é›†
                   - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç®¡ç†
                   
                2. **æ‰¿èªã‚·ã‚¹ãƒ†ãƒ **
                   - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿè¡Œã®æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
                   - å„ªå…ˆåº¦ãƒ™ãƒ¼ã‚¹ã®ã‚­ãƒ¥ãƒ¼ç®¡ç†
                   
                3. **å®Ÿè¡Œç›£è¦–**
                   - ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆã®å®Ÿè¡ŒçŠ¶æ³ç›£è¦–
                   - å®Ÿè¡Œãƒ­ã‚°ã®ä¿ç®¡ãƒ»è¡¨ç¤º
                
                ### ğŸš€ ä»Šå¾Œã®å±•é–‹
                
                - GitHub ISSUEé€£æºã®å®Ÿè£…
                - GPT-ENGINEERçµ±åˆã®å®Œå…¨è‡ªå‹•åŒ–
                - Controllerè‡ªå‹•èªè­˜ãƒ»çµ±åˆ
                - Google Chaté€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
                
                ### ğŸ“Š ç¾åœ¨ã®çŠ¶æ³
                
                - âœ… SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰æ¸ˆã¿
                - âœ… åŸºæœ¬çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†æ©Ÿèƒ½
                - âœ… æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
                - ğŸ”„ GitHubé€£æºæº–å‚™ä¸­
                - ğŸ”„ GPT-ENGINEERçµ±åˆæº–å‚™ä¸­
                
                ---
                **é–‹ç™ºè€…:** GitHub Copilot AI Assistant  
                **æœ€çµ‚æ›´æ–°:** 2025å¹´6æœˆ11æ—¥
                """)
        
        return interface

if __name__ == "__main__":
    # ãƒãƒ¼ãƒˆç¢ºèª
    import socket
    
    def is_port_available(port):
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            return s.connect_ex(('localhost', port)) != 0
    
    # åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚‹
    port = 7860
    while not is_port_available(port) and port < 7870:
        port += 1
    
    print(f"ğŸš€ çµ±åˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ä¸­...")
    print(f"ğŸŒ ãƒãƒ¼ãƒˆ: {port}")
    print(f"ğŸ”— URL: http://localhost:{port}")
    
    interface = create_interface()
    interface.launch(
        share=True,
        server_name="0.0.0.0",
        server_port=port,
        show_error=True
    )
