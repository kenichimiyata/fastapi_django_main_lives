#!/usr/bin/env python3
"""
æ‰¿èªæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ å®Ÿè¡Œãƒ„ãƒ¼ãƒ«
æ‰¿èªã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å®Ÿéš›ã«ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆãƒ»GitHub pushãƒ»Google Chaté€šçŸ¥ã¾ã§å®Ÿè¡Œã—ã¾ã™
"""

import sqlite3
import sys
import os
import json
import requests
import subprocess
from datetime import datetime
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
sys.path.append('/workspaces/fastapi_django_main_live')

class ApprovedItemExecutor:
    """æ‰¿èªæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã®å®Ÿè¡Œã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self.db_path = "/workspaces/fastapi_django_main_live/prompts.db"
        self.github_token = os.environ.get('GITHUB_TOKEN', '')
        self.google_chat_webhook = os.environ.get('GOOGLE_CHAT_WEBHOOK', '')
    
    def get_approved_items(self):
        """æ‰¿èªæ¸ˆã¿ã§ã¾ã å®Ÿè¡Œã•ã‚Œã¦ã„ãªã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT aq.id, aq.issue_title, aq.issue_body, aq.approved_by, aq.approved_at
                FROM approval_queue aq
                LEFT JOIN execution_log el ON aq.id = el.approval_id
                WHERE aq.approval_status = 'approved' 
                AND el.id IS NULL
                ORDER BY aq.approved_at ASC
            ''')
            
            items = cursor.fetchall()
            conn.close()
            return items
            
        except Exception as e:
            print(f"âŒ æ‰¿èªæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return []
    
    def create_execution_log(self, approval_id, status="started"):
        """å®Ÿè¡Œãƒ­ã‚°ã‚’ä½œæˆ"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                INSERT INTO execution_log (
                    approval_id, execution_start, status
                ) VALUES (?, CURRENT_TIMESTAMP, ?)
            ''', (approval_id, status))
            
            log_id = cursor.lastrowid
            conn.commit()
            conn.close()
            
            return log_id
            
        except Exception as e:
            print(f"âŒ å®Ÿè¡Œãƒ­ã‚°ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            return None
    
    def update_execution_log(self, log_id, status, result_summary="", github_repo_url="", error_message=""):
        """å®Ÿè¡Œãƒ­ã‚°ã‚’æ›´æ–°"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                UPDATE execution_log 
                SET execution_end = CURRENT_TIMESTAMP,
                    status = ?, result_summary = ?, 
                    github_repo_url = ?, error_message = ?
                WHERE id = ?
            ''', (status, result_summary, github_repo_url, error_message, log_id))
            
            conn.commit()
            conn.close()
            
            return True
            
        except Exception as e:
            print(f"âŒ å®Ÿè¡Œãƒ­ã‚°æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def simulate_system_generation(self, title, description):
        """ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆGPT-ENGINEERä»£æ›¿ï¼‰"""
        print(f"ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆé–‹å§‹: {title}")
        
        # ç°¡å˜ãªHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
        html_content = f"""<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <style>
        body {{
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }}
        .container {{
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }}
        h1 {{
            color: #333;
            text-align: center;
        }}
        .description {{
            background-color: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 20px 0;
        }}
        .footer {{
            text-align: center;
            margin-top: 30px;
            color: #666;
        }}
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ {title}</h1>
        <div class="description">
            <h3>ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦:</h3>
            <pre>{description}</pre>
        </div>
        <div class="footer">
            <p>âœ… ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆå®Œäº† - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
            <p>ğŸ¤– Generated by Auto System Creator</p>
        </div>
    </div>
</body>
</html>"""
        
        # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜å…ˆ
        output_dir = Path("/tmp/generated_system")
        output_dir.mkdir(exist_ok=True)
        
        html_file = output_dir / "index.html"
        with open(html_file, 'w', encoding='utf-8') as f:
            f.write(html_content)
        
        # README.mdã‚‚ç”Ÿæˆ
        readme_content = f"""# {title}

{description}

## ç”Ÿæˆæƒ…å ±
- ç”Ÿæˆæ—¥æ™‚: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
- ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ : Auto System Creator
- æ‰¿èªãƒ•ãƒ­ãƒ¼: GitHub ISSUE â†’ SQLiteæ‰¿èª â†’ è‡ªå‹•ç”Ÿæˆ

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
- index.html: ãƒ¡ã‚¤ãƒ³HTMLãƒ•ã‚¡ã‚¤ãƒ«
- README.md: ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«

## å®Ÿè¡Œæ–¹æ³•
ãƒ–ãƒ©ã‚¦ã‚¶ã§index.htmlã‚’é–‹ã„ã¦ãã ã•ã„ã€‚
"""
        
        readme_file = output_dir / "README.md"
        with open(readme_file, 'w', encoding='utf-8') as f:
            f.write(readme_content)
        
        print(f"âœ… ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆå®Œäº†: {output_dir}")
        return output_dir
    
    def create_github_repository_and_push(self, title, output_dir, approval_id):
        """GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’å®Ÿéš›ã«ä½œæˆã—ã€ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥"""
        if not self.github_token or len(self.github_token) < 10:
            return {
                'success': False,
                'repo_url': 'GitHub Tokenæœªè¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—',
                'message': 'GitHub Tokenæœªè¨­å®š'
            }
        
        try:
            # ãƒªãƒã‚¸ãƒˆãƒªåã‚’ç”Ÿæˆ
            repo_name = f"auto-generated-{approval_id}-{datetime.now().strftime('%Y%m%d-%H%M%S')}"
            
            # GitHub APIã§ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
            headers = {
                'Authorization': f'token {self.github_token}',
                'Accept': 'application/vnd.github.v3+json'
            }
            
            repo_data = {
                'name': repo_name,
                'description': f"è‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ : {title}",
                'private': False,
                'auto_init': False  # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚False
            }
            
            print(f"ğŸ“¡ GitHubãƒªãƒã‚¸ãƒˆãƒªä½œæˆä¸­: {repo_name}")
            response = requests.post(
                'https://api.github.com/user/repos',
                headers=headers,
                json=repo_data
            )
            
            if response.status_code != 201:
                return {
                    'success': False,
                    'repo_url': f'GitHub API ã‚¨ãƒ©ãƒ¼: {response.status_code}',
                    'message': f'ãƒªãƒã‚¸ãƒˆãƒªä½œæˆå¤±æ•—: {response.text}'
                }
            
            repo_info = response.json()
            clone_url = repo_info['clone_url']
            html_url = repo_info['html_url']
            
            print(f"âœ… GitHubãƒªãƒã‚¸ãƒˆãƒªä½œæˆæˆåŠŸ: {html_url}")
            
            # Gitè¨­å®š
            subprocess.run(['git', 'config', '--global', 'user.name', 'Auto System Creator'], 
                          cwd=output_dir, capture_output=True)
            subprocess.run(['git', 'config', '--global', 'user.email', 'auto-system@example.com'], 
                          cwd=output_dir, capture_output=True)
            
            # Gitãƒªãƒã‚¸ãƒˆãƒªåˆæœŸåŒ–ã¨ãƒ—ãƒƒã‚·ãƒ¥
            print(f"ğŸ“¤ ã‚³ãƒ¼ãƒ‰ã‚’GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­...")
            
            # HTTPSã§ã®pushç”¨ã«tokenä»˜ãURLã‚’ä½œæˆ
            auth_clone_url = clone_url.replace('https://', f'https://{self.github_token}@')
            
            subprocess.run(['git', 'init'], cwd=output_dir, check=True, capture_output=True)
            subprocess.run(['git', 'add', '.'], cwd=output_dir, check=True, capture_output=True)
            subprocess.run(['git', 'commit', '-m', f'Initial commit: {title}'], 
                          cwd=output_dir, check=True, capture_output=True)
            subprocess.run(['git', 'branch', '-M', 'main'], cwd=output_dir, check=True, capture_output=True)
            subprocess.run(['git', 'remote', 'add', 'origin', auth_clone_url], 
                          cwd=output_dir, check=True, capture_output=True)
            subprocess.run(['git', 'push', '-u', 'origin', 'main'], 
                          cwd=output_dir, check=True, capture_output=True)
            
            print(f"âœ… GitHubãƒ—ãƒƒã‚·ãƒ¥å®Œäº†: {html_url}")
            
            return {
                'success': True,
                'repo_url': html_url,
                'message': 'ãƒªãƒã‚¸ãƒˆãƒªä½œæˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†'
            }
            
        except subprocess.CalledProcessError as e:
            error_msg = f"Gitæ“ä½œã‚¨ãƒ©ãƒ¼: {e}"
            print(f"âŒ {error_msg}")
            return {
                'success': False,
                'repo_url': f'Gitæ“ä½œå¤±æ•—: {e.returncode}',
                'message': error_msg
            }
        except Exception as e:
            error_msg = f"GitHubå‡¦ç†ã‚¨ãƒ©ãƒ¼: {str(e)}"
            print(f"âŒ {error_msg}")
            return {
                'success': False,
                'repo_url': f'å‡¦ç†å¤±æ•—: {str(e)}',
                'message': error_msg
            }
    
    def send_google_chat_notification(self, title, message, success=True, github_url=None):
        """Google Chatã«é€šçŸ¥ã‚’é€ä¿¡"""
        if not self.google_chat_webhook:
            print("âš ï¸ Google Chat Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            return False
        
        icon = "âœ…" if success else "âŒ"
        
        # Google Chatç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        widgets = [
            {
                "textParagraph": {
                    "text": message
                }
            }
        ]
        
        # GitHubãƒªãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ã¨ã—ã¦è¿½åŠ 
        if github_url and github_url.startswith('https://github.com/'):
            widgets.append({
                "buttons": [
                    {
                        "textButton": {
                            "text": "ğŸ”— GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’é–‹ã",
                            "onClick": {
                                "openLink": {
                                    "url": github_url
                                }
                            }
                        }
                    }
                ]
            })
        
        payload = {
            "cards": [
                {
                    "header": {
                        "title": f"{icon} ã‚·ã‚¹ãƒ†ãƒ è‡ªå‹•ç”Ÿæˆé€šçŸ¥",
                        "subtitle": title,
                        "imageUrl": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                    },
                    "sections": [
                        {
                            "widgets": widgets
                        }
                    ]
                }
            ]
        }
        
        try:
            response = requests.post(
                self.google_chat_webhook,
                json=payload,
                headers={'Content-Type': 'application/json'}
            )
            
            if response.status_code == 200:
                print(f"âœ… Google Chaté€šçŸ¥é€ä¿¡æˆåŠŸ")
                return True
            else:
                print(f"âŒ Google Chaté€šçŸ¥é€ä¿¡å¤±æ•—: {response.status_code}")
                return False
                
        except Exception as e:
            print(f"âŒ Google Chaté€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def execute_approved_item(self, approval_id, title, description):
        """æ‰¿èªæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã‚’å®Ÿè¡Œ"""
        print(f"\nğŸš€ æ‰¿èªæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ å®Ÿè¡Œé–‹å§‹")
        print(f"ID: {approval_id}")
        print(f"ã‚¿ã‚¤ãƒˆãƒ«: {title}")
        print("-" * 60)
        
        # å®Ÿè¡Œãƒ­ã‚°é–‹å§‹
        log_id = self.create_execution_log(approval_id, "started")
        if not log_id:
            print("âŒ å®Ÿè¡Œãƒ­ã‚°ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ")
            return False
        
        try:
            # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆ
            print("ğŸ“ ã‚¹ãƒ†ãƒƒãƒ—1: ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆ")
            output_dir = self.simulate_system_generation(title, description)
            
            # ã‚¹ãƒ†ãƒƒãƒ—2: GitHub ãƒªãƒã‚¸ãƒˆãƒªä½œæˆã¨ãƒ—ãƒƒã‚·ãƒ¥
            print("ğŸ“ ã‚¹ãƒ†ãƒƒãƒ—2: GitHubå‡¦ç†")
            github_result = self.create_github_repository_and_push(title, output_dir, approval_id)
            
            if github_result['success']:
                github_url = github_result['repo_url']
                print(f"âœ… GitHubãƒªãƒã‚¸ãƒˆãƒªä½œæˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†: {github_url}")
            else:
                github_url = github_result['repo_url']
                print(f"âš ï¸ GitHubå‡¦ç†: {github_result['message']}")
            
            # ã‚¹ãƒ†ãƒƒãƒ—3: Google Chaté€šçŸ¥
            print("ğŸ“ ã‚¹ãƒ†ãƒƒãƒ—3: Google Chaté€šçŸ¥")
            notification_message = f"""ã‚·ã‚¹ãƒ†ãƒ è‡ªå‹•ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼

ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: {title}
ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«: {output_dir}
â° å®Œäº†æ™‚åˆ»: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

æ‰¿èªãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚"""
            
            self.send_google_chat_notification(
                title, 
                notification_message, 
                True, 
                github_url if github_result['success'] else None
            )
            
            # å®Ÿè¡Œãƒ­ã‚°å®Œäº†
            self.update_execution_log(
                log_id, 
                "completed", 
                f"ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆå®Œäº†: {output_dir}",
                github_url
            )
            
            print(f"\nğŸ‰ æ‰¿èªæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ å®Ÿè¡Œå®Œäº†!")
            print(f"âœ… ç”Ÿæˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {output_dir}")
            print(f"âœ… GitHub URL: {github_url}")
            
            return True
            
        except Exception as e:
            error_msg = f"å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {str(e)}"
            print(f"âŒ {error_msg}")
            
            # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ›´æ–°
            self.update_execution_log(log_id, "failed", "", "", error_msg)
            
            # ã‚¨ãƒ©ãƒ¼é€šçŸ¥
            self.send_google_chat_notification(
                title, 
                f"ã‚·ã‚¹ãƒ†ãƒ ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {error_msg}",
                False,
                None
            )
            
            return False
    
    def show_approved_items(self):
        """æ‰¿èªæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ã‚’è¡¨ç¤º"""
        items = self.get_approved_items()
        
        print("\nğŸ“‹ å®Ÿè¡Œå¾…ã¡ã®æ‰¿èªæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ :")
        print("=" * 80)
        
        if not items:
            print("  å®Ÿè¡Œå¾…ã¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“")
            return []
        
        for item in items:
            id, title, body, approved_by, approved_at = item
            print(f"âœ… ID:{id} | {title}")
            print(f"   æ‰¿èªè€…: {approved_by} | æ‰¿èªæ—¥æ™‚: {approved_at}")
            print(f"   æ¦‚è¦: {body[:100]}...")
            print("-" * 80)
        
        print(f"åˆè¨ˆ: {len(items)}ä»¶")
        return items

def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ"""
    print("ğŸš€ æ‰¿èªæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ å®Ÿè¡Œãƒ„ãƒ¼ãƒ«")
    print("=" * 60)
    
    executor = ApprovedItemExecutor()
    
    # ç¾åœ¨ã®å®Ÿè¡Œå¾…ã¡ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º
    items = executor.show_approved_items()
    
    if not items:
        print("\nğŸ¯ å®Ÿè¡Œå¯èƒ½ãªã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“")
        print("ã¾ãšæ‰¿èªã‚·ã‚¹ãƒ†ãƒ ã§ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ‰¿èªã—ã¦ãã ã•ã„")
        return
    
    print("\nğŸ“ å®Ÿè¡Œã—ãŸã„æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„:")
    print("1. ç‰¹å®šã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å®Ÿè¡Œ")
    print("2. ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é †æ¬¡å®Ÿè¡Œ")
    print("3. çµ‚äº†")
    
    choice = input("\né¸æŠ (1-3): ").strip()
    
    if choice == "1":
        item_id = input("å®Ÿè¡Œã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã®ID: ").strip()
        try:
            item_id = int(item_id)
            # æŒ‡å®šã•ã‚ŒãŸIDã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢
            target_item = None
            for item in items:
                if item[0] == item_id:
                    target_item = item
                    break
            
            if target_item:
                executor.execute_approved_item(
                    target_item[0],  # ID
                    target_item[1],  # title
                    target_item[2]   # body
                )
            else:
                print(f"âŒ ID {item_id} ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                
        except ValueError:
            print("âŒ ç„¡åŠ¹ãªIDå½¢å¼ã§ã™")
    
    elif choice == "2":
        print(f"\nğŸš€ {len(items)}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é †æ¬¡å®Ÿè¡Œã—ã¾ã™...")
        
        for i, item in enumerate(items, 1):
            print(f"\nğŸ“‹ {i}/{len(items)} ç•ªç›®ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å®Ÿè¡Œä¸­...")
            executor.execute_approved_item(
                item[0],  # ID
                item[1],  # title
                item[2]   # body
            )
    
    elif choice == "3":
        print("ğŸ‘‹ å®Ÿè¡Œãƒ„ãƒ¼ãƒ«ã‚’çµ‚äº†ã—ã¾ã™")
    
    else:
        print("âŒ ç„¡åŠ¹ãªé¸æŠã§ã™")

if __name__ == "__main__":
    main()
