#!/usr/bin/env python3
"""
å®Ÿéš›ã®Gradio APIã‚’ç¢ºèªã™ã‚‹ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""

import requests
import json
from gradio_client import Client
import time

def test_gradio_connection():
    """Gradio Clientã§ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ"""
    print("ğŸ” Gradio Clientæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...")
    
    urls = [
        "http://localhost:7860",
        "https://ideal-halibut-4q5qp79g2jp9-7860.app.github.dev"
    ]
    
    for url in urls:
        try:
            print(f"  ğŸ“¡ {url} ã¸ã®æ¥ç¶šè©¦è¡Œ...")
            client = Client(url)
            print(f"  âœ… {url} ã¸ã®æ¥ç¶šæˆåŠŸ!")
            
            # APIã®è©³ç´°æƒ…å ±ã‚’å–å¾—
            try:
                # view_apiæƒ…å ±ã‚’å–å¾—
                api_info = client.view_api(all_endpoints=True)
                print(f"  ğŸ” åˆ©ç”¨å¯èƒ½ãªAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ•°: {len(api_info)}")
                
                for i, endpoint in enumerate(api_info):
                    print(f"    {i+1}. APIå: {endpoint.get('api_name', 'Unknown')}")
                    print(f"       èª¬æ˜: {endpoint.get('description', 'No description')}")
                    print(f"       å…¥åŠ›: {endpoint.get('inputs', [])}")
                    print(f"       å‡ºåŠ›: {endpoint.get('outputs', [])}")
                    print()
                    
                    if i >= 5:  # æœ€åˆã®5ã¤ã ã‘è¡¨ç¤º
                        print("    ... (ä»–ã«ã‚‚APIãŒã‚ã‚Šã¾ã™)")
                        break
                        
                return client, url, api_info
                
            except Exception as e:
                print(f"  âš ï¸ APIæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
                return client, url, []
                
        except Exception as e:
            print(f"  âŒ {url} ã¸ã®æ¥ç¶šå¤±æ•—: {e}")
            continue
    
    return None, None, []

def test_api_endpoints(client, base_url, api_info):
    """å®Ÿéš›ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ"""
    print("\nğŸ§ª APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆé–‹å§‹...")
    
    test_results = []
    
    for endpoint in api_info[:3]:  # æœ€åˆã®3ã¤ã‚’ãƒ†ã‚¹ãƒˆ
        api_name = endpoint.get('api_name')
        if not api_name:
            continue
            
        print(f"  ğŸ” {api_name} ã‚’ãƒ†ã‚¹ãƒˆä¸­...")
        
        try:
            # ç°¡å˜ãªå…¥åŠ›ã§ãƒ†ã‚¹ãƒˆ
            if 'chat' in api_name.lower():
                result = client.predict("Hello", api_name=api_name)
            elif 'process' in api_name.lower():
                # ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ç³»ã¯ã‚¹ã‚­ãƒƒãƒ—
                print(f"    â­ï¸ ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ç³»APIã¯ã‚¹ã‚­ãƒƒãƒ—: {api_name}")
                continue
            else:
                # æ±ç”¨ãƒ†ã‚¹ãƒˆ
                result = client.predict("test", api_name=api_name)
            
            print(f"    âœ… {api_name}: æˆåŠŸ")
            print(f"    ğŸ“ çµæœ: {str(result)[:100]}...")
            
            test_results.append({
                "api_name": api_name,
                "success": True,
                "result": str(result)[:200]
            })
            
        except Exception as e:
            print(f"    âŒ {api_name}: å¤±æ•— - {e}")
            test_results.append({
                "api_name": api_name,
                "success": False,
                "error": str(e)
            })
    
    return test_results

def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    print("ğŸš€ å®Ÿéš›ã®Gradio APIç¢ºèªã‚·ã‚¹ãƒ†ãƒ é–‹å§‹")
    print("=" * 50)
    
    # æ¥ç¶šãƒ†ã‚¹ãƒˆ
    client, url, api_info = test_gradio_connection()
    
    if not client:
        print("âŒ ã©ã®URLã«ã‚‚æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ")
        return
    
    print(f"\nâœ… ä½¿ç”¨URL: {url}")
    print(f"ğŸ“Š ç™ºè¦‹ã•ã‚ŒãŸAPIæ•°: {len(api_info)}")
    
    # APIãƒ†ã‚¹ãƒˆ
    if api_info:
        test_results = test_api_endpoints(client, url, api_info)
        
        # çµæœã‚µãƒãƒªãƒ¼
        print("\nğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼:")
        success_count = sum(1 for r in test_results if r['success'])
        total_count = len(test_results)
        print(f"  æˆåŠŸ: {success_count}/{total_count}")
        
        # çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        with open("/workspaces/fastapi_django_main_live/api_test_results.json", "w", encoding="utf-8") as f:
            json.dump({
                "url": url,
                "api_info": api_info,
                "test_results": test_results,
                "timestamp": time.strftime("%Y-%m-%d %H:%M:%S")
            }, f, ensure_ascii=False, indent=2)
        
        print("ğŸ’¾ çµæœã‚’api_test_results.jsonã«ä¿å­˜ã—ã¾ã—ãŸ")
    
    print("\nğŸ‰ ãƒ†ã‚¹ãƒˆå®Œäº†!")

if __name__ == "__main__":
    main()
