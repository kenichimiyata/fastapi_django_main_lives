#!/usr/bin/env python3
"""
GitHub API ã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ†ã‚¹ãƒˆ
"""

import base64
import json
import requests
import subprocess
from pathlib import Path

def get_github_token():
    """GitHub ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—"""
    try:
        result = subprocess.run(['gh', 'auth', 'token'], capture_output=True, text=True, check=True)
        return result.stdout.strip()
    except subprocess.CalledProcessError:
        print("âŒ GitHubèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—")
        return None

def upload_image_via_api(image_path, issue_number):
    """GitHub APIçµŒç”±ã§ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"""
    token = get_github_token()
    if not token:
        return False
    
    # ç”»åƒã‚’base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    with open(image_path, 'rb') as f:
        image_data = f.read()
        image_base64 = base64.b64encode(image_data).decode('utf-8')
    
    # GitHub API endpoints
    repo_owner = "miyataken999"
    repo_name = "fastapi_django_main_live"
    
    # 1. ã¾ãšç”»åƒã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆGitHubçµŒç”±ã§ãƒ›ã‚¹ãƒˆï¼‰
    upload_url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/contents/temp_images/{image_path.name}"
    
    headers = {
        'Authorization': f'token {token}',
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
    }
    
    upload_data = {
        'message': f'Upload image for issue #{issue_number}',
        'content': image_base64
    }
    
    print(f"ğŸ“¤ GitHub APIã§ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...")
    
    try:
        response = requests.put(upload_url, headers=headers, json=upload_data)
        
        if response.status_code == 201:
            response_data = response.json()
            download_url = response_data['content']['download_url']
            print(f"âœ… ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: {download_url}")
            
            # 2. ã‚¤ã‚·ãƒ¥ãƒ¼ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆç”»åƒURLã‚’å«ã‚€ï¼‰
            comment_url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/issues/{issue_number}/comments"
            
            comment_body = f"""## ğŸ“· GitHub APIçµŒç”±ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `{image_path.name}`
**ã‚µã‚¤ã‚º**: {len(image_data)} bytes
**ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆ**: {download_url}

### ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒ

![{image_path.name}]({download_url})

### ãƒ†ã‚¹ãƒˆçµæœ
- âœ… ç”»åƒã®base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰: æˆåŠŸ
- âœ… GitHub APIã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: æˆåŠŸ  
- âœ… Markdownã§ã®ç”»åƒè¡¨ç¤º: ä¸Šè¨˜å‚ç…§
"""
            
            comment_data = {
                'body': comment_body
            }
            
            comment_response = requests.post(comment_url, headers=headers, json=comment_data)
            
            if comment_response.status_code == 201:
                print("âœ… ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ æˆåŠŸ")
                return True
            else:
                print(f"âŒ ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ å¤±æ•—: {comment_response.status_code}")
                print(f"âŒ Response: {comment_response.text}")
                return False
                
        else:
            print(f"âŒ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: {response.status_code}")
            print(f"âŒ Response: {response.text}")
            return False
            
    except Exception as e:
        print(f"âŒ APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: {e}")
        return False

if __name__ == "__main__":
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    image_path = Path("/workspaces/fastapi_django_main_live/docs/images/debug_captures/debug_capture_20250612_001613_fullpage.png")
    issue_number = "32"
    
    print("ğŸš€ GitHub API ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆé–‹å§‹")
    print("=" * 50)
    
    if image_path.exists():
        success = upload_image_via_api(image_path, issue_number)
        
        if success:
            print("\nğŸ‰ GitHub APIç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆæˆåŠŸï¼")
            print("ğŸŒ ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ã¦ãã ã•ã„:")
            print(f"   https://github.com/miyataken999/fastapi_django_main_live/issues/{issue_number}")
        else:
            print("\nâŒ GitHub APIç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆå¤±æ•—")
    else:
        print(f"âŒ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {image_path}")
