#!/usr/bin/env python3
"""
GitHub Issueç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
æ—¢å­˜ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒã‚’GitHubã‚¤ã‚·ãƒ¥ãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ†ã‚¹ãƒˆ
"""

import asyncio
import subprocess
import json
import os
from pathlib import Path
from datetime import datetime

class GitHubImageUploadTest:
    def __init__(self):
        self.image_dir = Path("/workspaces/fastapi_django_main_live/docs/images/debug_captures")
        self.test_issue_number = None
        
    def get_latest_image(self):
        """æœ€æ–°ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒã‚’å–å¾—"""
        images = list(self.image_dir.glob("*.png"))
        if not images:
            print("âŒ ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            return None
        
        latest_image = max(images, key=lambda p: p.stat().st_mtime)
        print(f"ğŸ“¸ ä½¿ç”¨ã™ã‚‹ç”»åƒ: {latest_image.name}")
        return latest_image
    
    def create_test_issue(self):
        """ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ä½œæˆ"""
        print("ğŸ†• ãƒ†ã‚¹ãƒˆç”¨ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ä½œæˆä¸­...")
        
        title = f"ğŸ§ª Image Upload Test - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        body = """## ğŸ§ª ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ

ã“ã®ã‚¤ã‚·ãƒ¥ãƒ¼ã¯ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆç”¨ã§ã™ã€‚

### ãƒ†ã‚¹ãƒˆå†…å®¹
- [ ] ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- [ ] ç”»åƒã®è¡¨ç¤ºç¢ºèª
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ç¢ºèª

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚åˆ»
""" + datetime.now().strftime('%Y-%m-%d %H:%M:%S')

        try:
            # GitHub CLIã§ã‚¤ã‚·ãƒ¥ãƒ¼ä½œæˆ
            cmd = [
                "gh", "issue", "create",
                "--title", title,
                "--body", body,
                "--label", "test,automation"
            ]
            
            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            
            # ã‚¤ã‚·ãƒ¥ãƒ¼ç•ªå·ã‚’æŠ½å‡º
            issue_url = result.stdout.strip()
            issue_number = issue_url.split('/')[-1]
            
            print(f"âœ… ãƒ†ã‚¹ãƒˆã‚¤ã‚·ãƒ¥ãƒ¼ä½œæˆå®Œäº†: #{issue_number}")
            print(f"ğŸŒ URL: {issue_url}")
            
            self.test_issue_number = issue_number
            return issue_number
            
        except subprocess.CalledProcessError as e:
            print(f"âŒ ã‚¤ã‚·ãƒ¥ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
            print(f"âŒ stderr: {e.stderr}")
            return None
    
    def upload_image_to_issue(self, image_path, issue_number):
        """ç”»åƒã‚’ã‚¤ã‚·ãƒ¥ãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"""
        print(f"ğŸ“¤ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: {image_path.name}")
        
        comment_body = f"""## ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ ãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `{image_path.name}`  
**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `{image_path}`  
**ã‚µã‚¤ã‚º**: {image_path.stat().st_size} bytes  
**ä½œæˆæ—¥æ™‚**: {datetime.fromtimestamp(image_path.stat().st_mtime)}

### ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒ
"""
        
        try:
            # ä¸€æ™‚çš„ãªMarkdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            temp_md = Path("/tmp/comment_with_image.md")
            with open(temp_md, 'w', encoding='utf-8') as f:
                f.write(comment_body)
            
            # GitHub CLIã§ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼ˆç”»åƒä»˜ãï¼‰
            cmd = [
                "gh", "issue", "comment", issue_number,
                "--body-file", str(temp_md)
            ]
            
            # ç”»åƒã‚’æ·»ä»˜
            cmd.extend(["--add-attachment", str(image_path)])
            
            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            
            print(f"âœ… ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†")
            print(f"ğŸ“ ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ : {result.stdout.strip()}")
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            temp_md.unlink()
            
            return True
            
        except subprocess.CalledProcessError as e:
            print(f"âŒ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: {e}")
            print(f"âŒ stderr: {e.stderr}")
            return False
    
    def verify_upload(self, issue_number):
        """ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç¢ºèª"""
        print(f"ğŸ” ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç¢ºèªä¸­...")
        
        try:
            # ã‚¤ã‚·ãƒ¥ãƒ¼ã®è©³ç´°ã‚’å–å¾—
            cmd = ["gh", "issue", "view", issue_number, "--json", "comments,body"]
            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            
            issue_data = json.loads(result.stdout)
            
            # ã‚³ãƒ¡ãƒ³ãƒˆã«ç”»åƒURLãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            has_image = False
            for comment in issue_data.get("comments", []):
                if "user-attachments" in comment.get("body", "") or ".png" in comment.get("body", ""):
                    has_image = True
                    print(f"âœ… ç”»åƒURLã‚’ç¢ºèª: ã‚³ãƒ¡ãƒ³ãƒˆå†…ã§ç”»åƒã‚’æ¤œå‡º")
                    break
            
            if not has_image:
                print("âš ï¸ ç”»åƒURLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                
            return has_image
            
        except subprocess.CalledProcessError as e:
            print(f"âŒ ç¢ºèªã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def run_complete_test(self):
        """å®Œå…¨ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"""
        print("ğŸš€ GitHubç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œå…¨ãƒ†ã‚¹ãƒˆé–‹å§‹")
        print("=" * 50)
        
        # 1. æœ€æ–°ç”»åƒã‚’å–å¾—
        image_path = self.get_latest_image()
        if not image_path:
            return False
        
        # 2. ãƒ†ã‚¹ãƒˆã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ä½œæˆ
        issue_number = self.create_test_issue()
        if not issue_number:
            return False
        
        # 3. ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        upload_success = self.upload_image_to_issue(image_path, issue_number)
        if not upload_success:
            return False
        
        # 4. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç¢ºèª
        verify_success = self.verify_upload(issue_number)
        
        # 5. çµæœã‚µãƒãƒªãƒ¼
        print("\n" + "=" * 50)
        print("ğŸ¯ ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼")
        print("=" * 50)
        print(f"ğŸ“¸ ä½¿ç”¨ç”»åƒ: {image_path.name}")
        print(f"ğŸ†” ãƒ†ã‚¹ãƒˆã‚¤ã‚·ãƒ¥ãƒ¼: #{issue_number}")
        print(f"ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: {'âœ… æˆåŠŸ' if upload_success else 'âŒ å¤±æ•—'}")
        print(f"ğŸ” ç¢ºèª: {'âœ… æˆåŠŸ' if verify_success else 'âŒ å¤±æ•—'}")
        
        overall_success = upload_success and verify_success
        print(f"ğŸ‰ ç·åˆçµæœ: {'âœ… æˆåŠŸ' if overall_success else 'âŒ å¤±æ•—'}")
        
        return overall_success

if __name__ == "__main__":
    tester = GitHubImageUploadTest()
    success = tester.run_complete_test()
    
    if success:
        print("\nğŸ‰ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº†ï¼GitHubã§ã®ç”»åƒè¡¨ç¤ºãŒå¯èƒ½ã§ã™ã€‚")
    else:
        print("\nâš ï¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
