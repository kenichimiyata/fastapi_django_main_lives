#!/usr/bin/env python3
"""
Codespace RPA ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ†ã‚¹ãƒˆ
============================
"""

import sys
import os
import asyncio
from datetime import datetime
from pathlib import Path
import time

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
sys.path.append('/workspaces/fastapi_django_main_live')

async def test_codespace_capture():
    """Codespaceç’°å¢ƒã§ã®RPAã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ†ã‚¹ãƒˆ"""
    
    print("ğŸš€ Codespace RPA ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ†ã‚¹ãƒˆé–‹å§‹")
    print(f"â° é–‹å§‹æ™‚åˆ»: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # RPAãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿
    try:
        from contbk.gra_12_rpa.rpa_automation import RPAManager
        print("âœ… RPAæ©Ÿèƒ½åˆ©ç”¨å¯èƒ½")
    except ImportError as e:
        print(f"âŒ RPAæ©Ÿèƒ½åˆ©ç”¨ä¸å¯: {e}")
        return
    
    # ä¿å­˜å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    save_dir = Path("/workspaces/fastapi_django_main_live/docs/images/debug_captures")
    save_dir.mkdir(parents=True, exist_ok=True)
    print(f"ğŸ“ ä¿å­˜å…ˆ: {save_dir}")
    
    # RPAãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
    rpa_manager = RPAManager()
    
    # Codespace URL
    target_url = "https://ideal-halibut-4q5qp79g2jp9-7860.app.github.dev/"
    print(f"ğŸŒ å¯¾è±¡URL: {target_url}")
    
    try:
        print("ğŸ“¸ ã‚­ãƒ£ãƒ—ãƒãƒ£å®Ÿè¡Œä¸­...")
        
        # å…¨ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ†ã‚¹ãƒˆ
        img, message = await rpa_manager.capture_screenshot(
            url=target_url,
            selector=None,  # å…¨ç”»é¢
            wait_time=8  # Codespaceèª­ã¿è¾¼ã¿æ™‚é–“ã‚’è€ƒæ…®
        )
        
        if img:
            # ä¿å­˜
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"codespace_capture_{timestamp}.png"
            filepath = save_dir / filename
            img.save(filepath)
            
            print(f"âœ… ã‚­ãƒ£ãƒ—ãƒãƒ£æˆåŠŸ!")
            print(f"ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: {filepath}")
            print(f"ğŸ“ ç”»åƒã‚µã‚¤ã‚º: {img.size}")
            print(f"ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {message}")
            
            # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
            if filepath.exists():
                size_kb = filepath.stat().st_size / 1024
                print(f"ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: {size_kb:.1f} KB")
            
            # ç‰¹å®šè¦ç´ ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚‚ãƒ†ã‚¹ãƒˆ
            print("\nğŸ¯ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æŒ‡å®šã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ†ã‚¹ãƒˆ...")
            
            selectors_to_test = [
                (".gradio-container", "ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ"),
                (".tab-nav", "ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³"),
                ("body", "ãƒšãƒ¼ã‚¸å…¨ä½“"),
            ]
            
            for selector, description in selectors_to_test:
                print(f"  ğŸ” {description}: {selector}")
                
                try:
                    img_sel, msg_sel = await rpa_manager.capture_screenshot(
                        url=target_url,
                        selector=selector,
                        wait_time=5
                    )
                    
                    if img_sel:
                        sel_filename = f"codespace_selector_{selector.replace('.', '').replace(' ', '_')}_{timestamp}.png"
                        sel_filepath = save_dir / sel_filename
                        img_sel.save(sel_filepath)
                        print(f"    âœ… æˆåŠŸ: {sel_filepath.name} ({img_sel.size})")
                    else:
                        print(f"    âŒ å¤±æ•—: {msg_sel}")
                        
                except Exception as e:
                    print(f"    âš ï¸ ã‚¨ãƒ©ãƒ¼: {str(e)}")
                
                # é–“éš”ã‚’ç©ºã‘ã‚‹
                await asyncio.sleep(2)
        
        else:
            print(f"âŒ ã‚­ãƒ£ãƒ—ãƒãƒ£å¤±æ•—: {message}")
    
    except Exception as e:
        print(f"âŒ å…¨ä½“ã‚¨ãƒ©ãƒ¼: {str(e)}")
        import traceback
        traceback.print_exc()
    
    finally:
        print(f"ğŸ ãƒ†ã‚¹ãƒˆçµ‚äº†: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

if __name__ == "__main__":
    asyncio.run(test_codespace_capture())
