#!/usr/bin/env python3
"""
DIãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç°¡å˜ãƒ†ã‚¹ãƒˆ
=====================
"""

import asyncio
from pathlib import Path

# ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«å®šç¾©
class DebugRecord:
    def __init__(self, **kwargs):
        self.id = kwargs.get('id')
        self.timestamp = kwargs.get('timestamp', '')
        self.url = kwargs.get('url', '')
        self.description = kwargs.get('description', '')
        self.selector = kwargs.get('selector')
        self.capture_path = kwargs.get('capture_path', '')
        self.analysis_prompt = kwargs.get('analysis_prompt', '')
        self.analysis_result = kwargs.get('analysis_result')
        self.status = kwargs.get('status', 'captured')
        self.created_at = kwargs.get('created_at', '')
        self.updated_at = kwargs.get('updated_at', '')

async def simple_di_test():
    """ç°¡å˜ãªDIãƒ†ã‚¹ãƒˆ"""
    print("ğŸ§ª ç°¡å˜ãªDIãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹")
    
    try:
        # DIãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
        import sys
        sys.path.append('/workspaces/fastapi_django_main_live')
        
        print("ğŸ“¦ DIãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...")
        from controllers.gra_03_programfromdocs.database_di_layer import (
            RepositoryFactory,
            DebugHistoryService,
            DebugRecord as DIDebugRecord
        )
        print("âœ… DIãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ")
        
        # SQLiteã‚µãƒ¼ãƒ“ã‚¹ä½œæˆ
        print("ğŸ“Š SQLiteã‚µãƒ¼ãƒ“ã‚¹ä½œæˆä¸­...")
        sqlite_service = RepositoryFactory.create_service("sqlite")
        print("âœ… SQLiteã‚µãƒ¼ãƒ“ã‚¹ä½œæˆæˆåŠŸ")
        
        # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜
        print("ğŸ’¾ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­...")
        record_id = await sqlite_service.save_debug_session(
            url="https://test-di.example.com",
            description="DIçµ±åˆãƒ†ã‚¹ãƒˆ - ç°¡å˜ç‰ˆ",
            selector=".test-class",
            capture_path="/tmp/test_di.png",
            analysis_prompt="ãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"
        )
        print(f"âœ… ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ: Record ID {record_id}")
        
        # å±¥æ­´å–å¾—
        print("ğŸ“‹ å±¥æ­´å–å¾—ä¸­...")
        history = await sqlite_service.get_debug_history_formatted(3)
        print(f"âœ… å±¥æ­´å–å¾—æˆåŠŸ:\n{history}")
        
        print("ğŸ‰ ç°¡å˜DIãƒ†ã‚¹ãƒˆå®Œäº†!")
        
    except ImportError as e:
        print(f"âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        print("ğŸ’¡ DIãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
        
    except Exception as e:
        print(f"âŒ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(simple_di_test())
