#!/usr/bin/env python3
"""
DIï¼ˆä¾å­˜æ€§æ³¨å…¥ï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
==========================================
"""

import asyncio
import sys
sys.path.append('/workspaces/fastapi_django_main_live')

from controllers.gra_03_programfromdocs.database_di_layer import (
    RepositoryFactory,
    DebugHistoryService,
    DebugRecord
)

async def test_di_pattern():
    """DIãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ†ã‚¹ãƒˆ"""
    print("ğŸ§ª ä¾å­˜æ€§æ³¨å…¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ†ã‚¹ãƒˆé–‹å§‹")
    
    # 1. SQLiteç‰ˆã§ãƒ†ã‚¹ãƒˆ
    print("\nğŸ“Š SQLite ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ†ã‚¹ãƒˆ")
    sqlite_service = RepositoryFactory.create_service("sqlite")
    
    # ãƒ‡ãƒãƒƒã‚°è¨˜éŒ²ã‚’ä¿å­˜
    record_id = await sqlite_service.save_debug_session(
        url="https://ideal-halibut-4q5qp79g2jp9-7860.app.github.dev/",
        description="DIçµ±åˆãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒãƒƒã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³",
        selector=".gradio-container",
        capture_path="/workspaces/fastapi_django_main_live/docs/images/debug_captures/test_di.png",
        analysis_prompt="DIçµ±åˆãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"
    )
    
    print(f"âœ… SQLiteä¿å­˜æˆåŠŸ: Record ID {record_id}")
    
    # å±¥æ­´å–å¾—
    history = await sqlite_service.get_debug_history_formatted(5)
    print(f"âœ… å±¥æ­´å–å¾—æˆåŠŸ:\n{history}")
    
    # 2. JSONç‰ˆã§ãƒ†ã‚¹ãƒˆ
    print("\nğŸ“ JSON ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ†ã‚¹ãƒˆ")
    json_service = RepositoryFactory.create_service("json")
    
    record_id_json = await json_service.save_debug_session(
        url="https://json-test.example.com",
        description="JSONç‰ˆDIãƒ†ã‚¹ãƒˆ",
        selector=None,
        capture_path="/tmp/json_test.png",
        analysis_prompt="JSONç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"
    )
    
    print(f"âœ… JSONä¿å­˜æˆåŠŸ: Record ID {record_id_json}")
    
    # 3. çµ±è¨ˆæƒ…å ±ãƒ†ã‚¹ãƒˆ
    print("\nğŸ“ˆ çµ±è¨ˆæƒ…å ±ã®ãƒ†ã‚¹ãƒˆ")
    stats = await sqlite_service.get_url_statistics("https://ideal-halibut-4q5qp79g2jp9-7860.app.github.dev/")
    print(f"âœ… çµ±è¨ˆæƒ…å ±: {stats}")
    
    # 4. æ¤œç´¢ãƒ†ã‚¹ãƒˆ
    print("\nğŸ” æ¤œç´¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ")
    search_results = await sqlite_service.search_debug_history("DIçµ±åˆ")
    print(f"âœ… æ¤œç´¢çµæœ: {len(search_results)}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ")
    
    for result in search_results[:3]:
        print(f"   - {result.description[:50]}...")
    
    # 5. è§£æçµæœæ›´æ–°ãƒ†ã‚¹ãƒˆ
    print("\nğŸ”„ è§£æçµæœæ›´æ–°ã®ãƒ†ã‚¹ãƒˆ")
    if record_id:
        update_success = await sqlite_service.complete_analysis(
            record_id, 
            "DIãƒ†ã‚¹ãƒˆå®Œäº†: æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™"
        )
        print(f"âœ… è§£æçµæœæ›´æ–°: {'æˆåŠŸ' if update_success else 'å¤±æ•—'}")
    
    print("\nğŸ‰ DIãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆå®Œäº†!")
    print("=" * 60)
    print("âœ… SQLiteæ°¸ç¶šåŒ– - æœ¬ç•ªç’°å¢ƒç”¨")
    print("âœ… JSONãƒ•ã‚¡ã‚¤ãƒ« - é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨")
    print("âœ… ä¾å­˜æ€§æ³¨å…¥ - æŸ”è»Ÿãªå®Ÿè£…åˆ‡ã‚Šæ›¿ãˆ")
    print("âœ… ã‚µãƒ¼ãƒ“ã‚¹å±¤ - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯åˆ†é›¢")
    print("âœ… æ¤œç´¢ãƒ»çµ±è¨ˆ - é«˜åº¦ãªãƒ‡ãƒ¼ã‚¿æ“ä½œ")

if __name__ == "__main__":
    asyncio.run(test_di_pattern())
