#!/usr/bin/env python3
"""
ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆç‰ˆ
ã‚¿ãƒ–ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã®æ¤œè¨¼ç”¨
"""

import sys
import os
sys.path.append('/workspaces/fastapi_django_main_live')

import gradio as gr
import sqlite3
from datetime import datetime
from typing import List, Tuple

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
DB_PATH = "prompts.db"

def get_prompts() -> List[Tuple]:
    """å…¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('SELECT id, title, url, created_at FROM prompts ORDER BY created_at DESC')
        prompts = cursor.fetchall()
        conn.close()
        return prompts
    except Exception as e:
        print(f"âŒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return []

def get_prompt_content(prompt_id: int) -> str:
    """æŒ‡å®šIDã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã‚’å–å¾—"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute('SELECT content FROM prompts WHERE id = ?', (prompt_id,))
        result = cursor.fetchone()
        conn.close()
        return result[0] if result else ""
    except Exception as e:
        print(f"âŒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return ""

def get_prompt_choices():
    """ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€è¦§ã®choicesã‚’å–å¾—"""
    prompts = get_prompts()
    choices = []
    for prompt in prompts:
        id_, title, url, created_at = prompt
        display_text = f"[{id_}] {title} ({created_at[:10]})"
        choices.append((display_text, str(id_)))
    return choices

# ã‚·ãƒ³ãƒ—ãƒ«ãªGradioã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
def create_interface():
    """ã‚¨ãƒ©ãƒ¼ã®å°‘ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½œæˆ"""
    
    def handle_load_prompt(selected_prompt):
        print(f"ğŸ“¥ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿è¦æ±‚: {selected_prompt}")
        if selected_prompt:
            try:
                # å€¤ãŒã‚¿ãƒ—ãƒ«ã®å ´åˆã€è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æŠ½å‡º
                if isinstance(selected_prompt, tuple):
                    display_text, prompt_id = selected_prompt
                else:
                    # æ–‡å­—åˆ—ã®å ´åˆã€IDã‚’æŠ½å‡º
                    prompt_id = selected_prompt.split(']')[0][1:] if '[' in selected_prompt else selected_prompt
                
                print(f"ğŸ” æŠ½å‡ºã•ã‚ŒãŸID: {prompt_id}")
                content = get_prompt_content(int(prompt_id))
                print(f"ğŸ“„ å–å¾—ã—ãŸå†…å®¹ã®é•·ã•: {len(content)} æ–‡å­—")
                return content
            except Exception as e:
                print(f"âŒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
                return f"ã‚¨ãƒ©ãƒ¼: {str(e)}"
        return ""
    
    # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä½œæˆ
    with gr.Blocks(title="ğŸš€ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ãƒ†ã‚¹ãƒˆ", theme=gr.themes.Soft()) as interface:
        gr.Markdown("# ğŸ§ª ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ†ã‚¹ãƒˆç‰ˆ")
        gr.Markdown("ã‚¿ãƒ–ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã®ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆã§ã™")
        
        # ã‚·ãƒ³ãƒ—ãƒ«ãªå˜ä¸€ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
        with gr.Row():
            with gr.Column(scale=1):
                prompt_dropdown = gr.Dropdown(
                    choices=get_prompt_choices(),
                    label="ğŸ“‹ ä¿å­˜æ¸ˆã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€è¦§",
                    interactive=True,
                    value=None
                )
                load_btn = gr.Button("ğŸ“¥ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿", variant="primary")
                
            with gr.Column(scale=2):
                prompt_content = gr.Textbox(
                    label="ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹",
                    lines=15,
                    value="",
                    placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„..."
                )
        
        # ã‚¤ãƒ™ãƒ³ãƒˆæ¥ç¶š
        load_btn.click(
            handle_load_prompt,
            inputs=[prompt_dropdown],
            outputs=[prompt_content]
        )
        
        # ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³é¸æŠæ™‚ã®è‡ªå‹•èª­ã¿è¾¼ã¿
        prompt_dropdown.change(
            handle_load_prompt,
            inputs=[prompt_dropdown],
            outputs=[prompt_content]
        )
    
    return interface

if __name__ == "__main__":
    print("ğŸ§ª ã‚·ãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ä¸­...")
    interface = create_interface()
    interface.launch(
        server_name="0.0.0.0",
        server_port=7863,  # æœªä½¿ç”¨ãƒãƒ¼ãƒˆã‚’æŒ‡å®š
        share=False,
        debug=True
    )
