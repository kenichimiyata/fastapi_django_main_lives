#!/usr/bin/env python3
"""
RPAç”»åƒå–å¾—æ©Ÿèƒ½ - å®Ÿéš›ã®ã‚µã‚¤ãƒˆãƒ†ã‚¹ãƒˆ
===================================

GitHub Pagesã‚„å®Ÿéš›ã®ç”»åƒã‚’å«ã‚€ã‚µã‚¤ãƒˆã§
RPAç”»åƒå–å¾—æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚
"""

import asyncio
import sys
import os
from pathlib import Path

# ãƒ‘ã‚¹ã‚’è¿½åŠ 
sys.path.append('/workspaces/fastapi_django_main_live')

from contbk.gra_12_rpa.rpa_automation import RPAManager

async def test_github_image_collection():
    """GitHub ãƒªãƒã‚¸ãƒˆãƒªãƒšãƒ¼ã‚¸ã‹ã‚‰ç”»åƒã‚’å–å¾—"""
    print("ğŸ”¥ Issue #5å¯¾å¿œ: GitHubå®Ÿã‚µã‚¤ãƒˆã§ã®ç”»åƒå–å¾—ãƒ†ã‚¹ãƒˆ")
    print("=" * 60)
    
    rpa = RPAManager()
    
    # ãƒ†ã‚¹ãƒˆå¯¾è±¡URLï¼ˆGitHub Pages - ã‚ˆãç”»åƒãŒå«ã¾ã‚Œã‚‹ã‚µã‚¤ãƒˆï¼‰
    test_urls = [
        "https://github.com/miyataken999/fastapi_django_main_live",  # è‡ªåˆ†ã®ãƒªãƒã‚¸ãƒˆãƒª
        "https://github.com/microsoft/vscode",  # VSCodeãƒªãƒã‚¸ãƒˆãƒªï¼ˆã‚ˆãç”»åƒãŒã‚ã‚‹ï¼‰
        "https://docs.github.com/ja",  # GitHub Docsï¼ˆå¤šãã®ç”»åƒï¼‰
    ]
    
    all_downloaded = []
    
    for i, url in enumerate(test_urls, 1):
        print(f"\nğŸ¯ ãƒ†ã‚¹ãƒˆ {i}/3: {url}")
        print("-" * 50)
        
        try:
            # ç”»åƒå–å¾—å®Ÿè¡Œ
            downloaded_files, message = await rpa.collect_images_from_page(
                url=url,
                image_selector="img",
                download_path=f"/workspaces/fastapi_django_main_live/docs/images/collected/test_{i}",
                limit=5  # ãƒ†ã‚¹ãƒˆãªã®ã§5æšã¾ã§
            )
            
            print(f"ğŸ“Š çµæœ: {message}")
            print(f"ğŸ“ å–å¾—ãƒ•ã‚¡ã‚¤ãƒ«æ•°: {len(downloaded_files)}")
            
            if downloaded_files:
                print("ğŸ“¸ å–å¾—ã—ãŸç”»åƒ:")
                for file_path in downloaded_files:
                    file_size = os.path.getsize(file_path) if os.path.exists(file_path) else 0
                    print(f"  âœ… {os.path.basename(file_path)} ({file_size:,} bytes)")
                
                all_downloaded.extend(downloaded_files)
            else:
                print("  âš ï¸ ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
                
        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
    
    # ç·åˆçµæœ
    print(f"\nğŸ“Š ãƒ†ã‚¹ãƒˆå®Œäº†ã‚µãƒãƒªãƒ¼:")
    print(f"  - ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚µã‚¤ãƒˆæ•°: {len(test_urls)}")
    print(f"  - ç·å–å¾—ç”»åƒæ•°: {len(all_downloaded)}")
    print(f"  - å–å¾—æˆåŠŸç‡: {len([f for f in all_downloaded if os.path.exists(f)])/max(len(all_downloaded), 1)*100:.1f}%")
    
    # ã‚®ãƒ£ãƒ©ãƒªãƒ¼ä½œæˆ
    if all_downloaded:
        print(f"\nğŸ–¼ï¸ ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ä½œæˆä¸­...")
        gallery_path = await rpa.create_image_gallery(
            image_paths=all_downloaded,
            output_path="/workspaces/fastapi_django_main_live/docs/rpa_image_gallery.html"
        )
        print(f"âœ… ã‚®ãƒ£ãƒ©ãƒªãƒ¼ä½œæˆå®Œäº†: {gallery_path}")
        
        # READMEç”¨ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚‚ä½œæˆ
        create_demo_markdown(all_downloaded)
        
        return True, f"âœ… {len(all_downloaded)}å€‹ã®ç”»åƒã‚’å–å¾—ã—ã€ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ"
    else:
        return False, "âŒ ç”»åƒå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"

def create_demo_markdown(image_paths):
    """ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ä½œæˆ"""
    
    demo_content = f"""# ğŸ–¼ï¸ RPAç”»åƒå–å¾—ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

## ğŸ“¸ æ©Ÿèƒ½æ¦‚è¦
Issue #5ã€ŒRPAã§ç”»åƒå–å¾—ãŒã§ããªã‚‰ã€ã«å¯¾å¿œã—ãŸç”»åƒå–å¾—æ©Ÿèƒ½ã®ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

## âœ… å®Ÿè£…å®Œäº†æ©Ÿèƒ½
- ğŸ¯ **è‡ªå‹•ç”»åƒç™ºè¦‹**: ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‹ã‚‰ç”»åƒè¦ç´ ã‚’è‡ªå‹•æ¤œå‡º
- ğŸ“¥ **ãƒãƒƒãƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**: è¤‡æ•°ç”»åƒã®ä¸€æ‹¬å–å¾—
- ğŸ—‚ï¸ **æ•´ç†ä¿å­˜**: å–å¾—æ—¥æ™‚ãƒ»ã‚µã‚¤ãƒˆåˆ¥ã®è‡ªå‹•åˆ†é¡
- ğŸ–¼ï¸ **ã‚®ãƒ£ãƒ©ãƒªãƒ¼ç”Ÿæˆ**: HTMLã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®è‡ªå‹•ä½œæˆ
- ğŸ“Š **å®Ÿè¡Œå±¥æ­´**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã®å–å¾—è¨˜éŒ²ç®¡ç†

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ
- **å–å¾—ç”»åƒæ•°**: {len(image_paths)}æš
- **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ—¥æ™‚**: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æˆåŠŸ

## ğŸ–¼ï¸ å–å¾—ç”»åƒä¸€è¦§
"""
    
    for i, path in enumerate(image_paths, 1):
        if os.path.exists(path):
            file_size = os.path.getsize(path)
            filename = os.path.basename(path)
            demo_content += f"\n{i}. **{filename}** ({file_size:,} bytes)"
    
    demo_content += f"""

## ğŸš€ ä½¿ç”¨æ–¹æ³•
```python
from contbk.gra_12_rpa.rpa_automation import RPAManager

# RPAç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
rpa = RPAManager()

# ç”»åƒå–å¾—å®Ÿè¡Œ
downloaded_files, message = await rpa.collect_images_from_page(
    url="https://example.com",
    image_selector="img",
    download_path="./images",
    limit=10
)

# ã‚®ãƒ£ãƒ©ãƒªãƒ¼ä½œæˆ
gallery_path = await rpa.create_image_gallery(downloaded_files)
```

## ğŸ¯ Issue #5 å¯¾å¿œçŠ¶æ³
- âœ… **æ©Ÿèƒ½å®Ÿè£…**: å®Œäº†
- âœ… **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**: å®Œäº†  
- âœ… **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: å®Œäº†
- ğŸ”„ **Issue ã‚¯ãƒ­ãƒ¼ã‚º**: æº–å‚™å®Œäº†

---
*Generated by RPA Image Collection System - {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*
"""
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
    demo_path = "/workspaces/fastapi_django_main_live/docs/rpa_image_collection_demo.md"
    with open(demo_path, 'w', encoding='utf-8') as f:
        f.write(demo_content)
    
    print(f"ğŸ“ ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è³‡æ–™ä½œæˆå®Œäº†: {demo_path}")

if __name__ == "__main__":
    import datetime
    
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    success, message = asyncio.run(test_github_image_collection())
    
    print(f"\nğŸ æœ€çµ‚çµæœ:")
    print(f"  - æ©Ÿèƒ½å‹•ä½œ: {'âœ… æˆåŠŸ' if success else 'âŒ å¤±æ•—'}")
    print(f"  - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {message}")
    
    if success:
        print(f"\nğŸ‰ Issue #5ã€ŒRPAã§ç”»åƒå–å¾—ãŒã§ããªã‚‰ã€è§£æ±ºæº–å‚™å®Œäº†ï¼")
        print(f"   GitHub Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã§ãã¾ã™ã€‚")
    else:
        print(f"\nâš ï¸ ä¸€éƒ¨æ©Ÿèƒ½ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚è¦èª¿æ•´ã€‚")
