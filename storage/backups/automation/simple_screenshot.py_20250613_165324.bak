"""
ç°¡å˜ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ãƒ„ãƒ¼ãƒ«
===============================

Playwrightã§Webãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
"""

import asyncio
import os
from pathlib import Path

async def capture_website_screenshots():
    """Webã‚µã‚¤ãƒˆã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—"""
    
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    screenshots_dir = Path("/workspaces/fastapi_django_main_live/docs/images/screenshots")
    screenshots_dir.mkdir(parents=True, exist_ok=True)
    
    try:
        from playwright.async_api import async_playwright
        
        async with async_playwright() as p:
            # ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•
            browser = await p.chromium.launch(headless=True)
            context = await browser.new_context(
                viewport={'width': 1920, 'height': 1080}
            )
            page = await context.new_page()
            
            # å–å¾—å¯¾è±¡
            targets = [
                {
                    "url": "https://ideal-halibut-4q5qp79g2jp9-7860.app.github.dev/",
                    "filename": "main_dashboard.png",
                    "name": "ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"
                },
                {
                    "url": "http://localhost:7865",
                    "filename": "contbk_dashboard.png", 
                    "name": "ContBKçµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"
                }
            ]
            
            results = []
            
            for target in targets:
                try:
                    print(f"ğŸ“¸ {target['name']} ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ä¸­...")
                    
                    # ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
                    await page.goto(target["url"], wait_until="networkidle")
                    
                    # å°‘ã—å¾…æ©Ÿ
                    await asyncio.sleep(3)
                    
                    # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—
                    screenshot_path = screenshots_dir / target["filename"]
                    await page.screenshot(path=str(screenshot_path), full_page=True)
                    
                    if screenshot_path.exists():
                        print(f"âœ… {target['name']}: {screenshot_path}")
                        results.append({
                            "success": True,
                            "target": target,
                            "path": screenshot_path
                        })
                    else:
                        print(f"âŒ {target['name']}: ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¤±æ•—")
                        results.append({
                            "success": False,
                            "target": target,
                            "error": "ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¤±æ•—"
                        })
                        
                except Exception as e:
                    print(f"âŒ {target['name']}: {e}")
                    results.append({
                        "success": False,
                        "target": target,
                        "error": str(e)
                    })
            
            await browser.close()
            return results
            
    except ImportError:
        print("âŒ Playwright not installed. Install with: pip install playwright && playwright install")
        return []
    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
        return []

async def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    print("ğŸš€ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—é–‹å§‹...")
    
    results = await capture_website_screenshots()
    
    # çµæœé›†è¨ˆ
    successful = [r for r in results if r.get("success", False)]
    
    print(f"\nğŸ“Š çµæœ: {len(successful)}/{len(results)} æˆåŠŸ")
    
    if successful:
        print("\nâœ… å–å¾—æˆåŠŸ:")
        for result in successful:
            print(f"  - {result['target']['name']}: {result['path']}")
    
    if results and any(r.get("success") for r in results):
        print("\nğŸ”„ Gitã«ã‚³ãƒŸãƒƒãƒˆä¸­...")
        
        # Gitæ“ä½œ
        import subprocess
        
        try:
            # Git add
            subprocess.run(['git', 'add', 'docs/images/screenshots/'], 
                         cwd='/workspaces/fastapi_django_main_live', check=True)
            
            # Git commit
            subprocess.run(['git', 'commit', '-m', 
                          'ğŸ“¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¿½åŠ \n\n- ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚­ãƒ£ãƒ—ãƒãƒ£\n- ContBKçµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚­ãƒ£ãƒ—ãƒãƒ£\n- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”¨ç”»é¢è³‡æ–™å®Œå‚™'], 
                         cwd='/workspaces/fastapi_django_main_live', check=True)
            
            print("âœ… Gitã‚³ãƒŸãƒƒãƒˆå®Œäº†")
            
        except subprocess.CalledProcessError as e:
            print(f"âš ï¸ Gitæ“ä½œã‚¨ãƒ©ãƒ¼: {e}")
    
    print("\nğŸ‰ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—å®Œäº†!")

if __name__ == "__main__":
    asyncio.run(main())
