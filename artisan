#!/usr/bin/env python3
"""
ğŸ¨ Artisan - Laravelé¢¨ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ« for Python
=====================================================

Laravel Artisanã‚³ãƒãƒ³ãƒ‰ã‚’Pythonã§å†ç¾
ä¾¿åˆ©ãªCLIãƒ„ãƒ¼ãƒ«ã§é–‹ç™ºåŠ¹ç‡ã‚’å¤§å¹…å‘ä¸Š
"""

import sys
import os
import argparse
from pathlib import Path
from datetime import datetime
import importlib.util

class ArtisanCommand:
    """Artisané¢¨ã‚³ãƒãƒ³ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self.project_root = Path(__file__).parent
        
    def handle(self, *args, **kwargs):
        """ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯"""
        raise NotImplementedError("handle method must be implemented")

class MakeControllerCommand(ArtisanCommand):
    """ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä½œæˆã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, name, *args, **kwargs):
        controller_path = self.project_root / "laravel_app" / "Http" / "Controllers" / f"{name}.py"
        controller_content = f'''"""
{name} Controller
=================

Generated by Artisan on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
"""

from fastapi import APIRouter, Request, HTTPException
from typing import Dict, Any

router = APIRouter()

class {name}:
    """
    {name} Controller
    
    Handle HTTP requests for {name.lower()} related operations
    """
    
    def __init__(self):
        self.router = router
    
    @router.get("/")
    async def index(self) -> Dict[str, Any]:
        """
        Display a listing of the resource
        """
        return {{"message": "Hello from {name}!"}}
    
    @router.post("/")
    async def store(self, request: Request) -> Dict[str, Any]:
        """
        Store a newly created resource
        """
        return {{"message": "Resource created successfully"}}
    
    @router.get("/{{id}}")
    async def show(self, id: int) -> Dict[str, Any]:
        """
        Display the specified resource
        """
        return {{"message": f"Showing resource {{id}}"}}
    
    @router.put("/{{id}}")
    async def update(self, id: int, request: Request) -> Dict[str, Any]:
        """
        Update the specified resource
        """
        return {{"message": f"Resource {{id}} updated successfully"}}
    
    @router.delete("/{{id}}")
    async def destroy(self, id: int) -> Dict[str, Any]:
        """
        Remove the specified resource
        """
        return {{"message": f"Resource {{id}} deleted successfully"}}
'''
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        controller_path.parent.mkdir(parents=True, exist_ok=True)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        with open(controller_path, 'w', encoding='utf-8') as f:
            f.write(controller_content)
            
        print(f"âœ… Controller created: {controller_path}")
        return True

class MakeModelCommand(ArtisanCommand):
    """ãƒ¢ãƒ‡ãƒ«ä½œæˆã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, name, *args, **kwargs):
        model_path = self.project_root / "laravel_app" / "Models" / f"{name}.py"
        model_content = f'''"""
{name} Model
============

Generated by Artisan on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
"""

from sqlalchemy import Column, Integer, String, DateTime, Boolean
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.sql import func
from typing import Optional

Base = declarative_base()

class {name}(Base):
    """
    {name} Model
    
    SQLAlchemy model for {name.lower()} table
    """
    
    __tablename__ = "{name.lower()}s"
    
    # Primary Key
    id = Column(Integer, primary_key=True, index=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    
    # Add your fields here
    # name = Column(String(255), nullable=False)
    # email = Column(String(255), unique=True, index=True)
    # is_active = Column(Boolean, default=True)
    
    def __repr__(self):
        return f"<{name}(id={{self.id}})>"
    
    def to_dict(self):
        """Convert model to dictionary"""
        return {{
            "id": self.id,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
            # Add your fields here
        }}
'''
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        model_path.parent.mkdir(parents=True, exist_ok=True)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        with open(model_path, 'w', encoding='utf-8') as f:
            f.write(model_content)
            
        print(f"âœ… Model created: {model_path}")
        return True

class MakeServiceCommand(ArtisanCommand):
    """ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, name, *args, **kwargs):
        service_path = self.project_root / "laravel_app" / "Services" / f"{name}Service.py"
        service_content = f'''"""
{name} Service
==============

Generated by Artisan on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
"""

from typing import Dict, List, Any, Optional
import asyncio

class {name}Service:
    """
    {name} Service
    
    Business logic for {name.lower()} operations
    """
    
    def __init__(self):
        pass
    
    async def get_all(self) -> List[Dict[str, Any]]:
        """
        Get all {name.lower()} records
        """
        # Implement your logic here
        return []
    
    async def get_by_id(self, id: int) -> Optional[Dict[str, Any]]:
        """
        Get {name.lower()} by ID
        """
        # Implement your logic here
        return None
    
    async def create(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Create new {name.lower()}
        """
        # Implement your logic here
        return {{"message": "{name} created successfully"}}
    
    async def update(self, id: int, data: Dict[str, Any]) -> Dict[str, Any]:
        """
        Update {name.lower()}
        """
        # Implement your logic here
        return {{"message": f"{name} {{id}} updated successfully"}}
    
    async def delete(self, id: int) -> Dict[str, Any]:
        """
        Delete {name.lower()}
        """
        # Implement your logic here
        return {{"message": f"{name} {{id}} deleted successfully"}}
'''
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        service_path.parent.mkdir(parents=True, exist_ok=True)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        with open(service_path, 'w', encoding='utf-8') as f:
            f.write(service_content)
            
        print(f"âœ… Service created: {service_path}")
        return True

class MakeHybridControllerCommand(ArtisanCommand):
    """ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä½œæˆã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, name, controller_type="hybrid", *args, **kwargs):
        if controller_type.lower() == "api":
            base_path = self.project_root / "laravel_app" / "Http" / "Controllers" / "Api"
            parent_class = "FastApiController"
            from_import = "from app.Http.Controllers.Api.FastApiController import FastApiController"
        elif controller_type.lower() == "web":
            base_path = self.project_root / "laravel_app" / "Http" / "Controllers" / "Web"
            parent_class = "WebController"
            from_import = "from app.Http.Controllers.Web.WebController import WebController"
        elif controller_type.lower() == "gradio":
            base_path = self.project_root / "laravel_app" / "Http" / "Controllers" / "Gradio"
            parent_class = "GradioController"
            from_import = "from app.Http.Controllers.Gradio.GradioController import GradioController"
        else:
            base_path = self.project_root / "laravel_app" / "Http" / "Controllers"
            parent_class = "HybridController"
            from_import = "from app.Http.Controllers.HybridController import HybridController"
        
        controller_path = base_path / f"{name}.py"
        controller_content = f'''"""
{name} - Laravelé¢¨ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
Generated by Artisan on {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
Type: {controller_type.upper()}
"""

{from_import}
from fastapi import Request, HTTPException
from typing import Dict, Any
import logging

logger = logging.getLogger(__name__)

class {name}({parent_class}):
    """
    {name} 
    
    Laravelé¢¨ã®{controller_type.upper()}ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
    Django + FastAPI + Gradio çµ±åˆå¯¾å¿œ
    """
    
    def __init__(self):
        super().__init__()
        # ã‚«ã‚¹ã‚¿ãƒ åˆæœŸåŒ–å‡¦ç†ã‚’ã“ã“ã«è¿½åŠ 
        
    async def index(self) -> Dict[str, Any]:
        """
        ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§è¡¨ç¤º
        GET /
        """
        return {{
            "status": "success",
            "data": [
                {{"id": 1, "name": "Sample Resource", "controller": "{name}"}},
            ],
            "message": f"{{self.__class__.__name__}} index called successfully",
            "controller_type": "{controller_type}"
        }}
    
    async def store(self, request: Request) -> Dict[str, Any]:
        """
        æ–°è¦ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ
        POST /
        """
        try:
            body = await request.json()
            return {{
                "status": "success",
                "data": {{
                    "id": 999,
                    "created_data": body,
                    "controller": "{name}",
                    "created_at": "{datetime.now().isoformat()}"
                }},
                "message": "Resource created successfully"
            }}
        except Exception as e:
            logger.error(f"Store error in {{self.__class__.__name__}}: {{e}}")
            raise HTTPException(status_code=400, detail=str(e))
    
    async def show(self, id: int) -> Dict[str, Any]:
        """
        ç‰¹å®šãƒªã‚½ãƒ¼ã‚¹è¡¨ç¤º
        GET /{{id}}
        """
        return {{
            "status": "success",
            "data": {{
                "id": id,
                "name": f"Resource {{id}}",
                "controller": "{name}",
                "type": "{controller_type}_resource"
            }},
            "message": f"Resource {{id}} retrieved successfully"
        }}
    
    async def update(self, id: int, request: Request) -> Dict[str, Any]:
        """
        ãƒªã‚½ãƒ¼ã‚¹æ›´æ–°
        PUT /{{id}}
        """
        try:
            body = await request.json()
            return {{
                "status": "success",
                "data": {{
                    "id": id,
                    "updated_data": body,
                    "controller": "{name}",
                    "updated_at": "{datetime.now().isoformat()}"
                }},
                "message": f"Resource {{id}} updated successfully"
            }}
        except Exception as e:
            logger.error(f"Update error in {{self.__class__.__name__}}: {{e}}")
            raise HTTPException(status_code=400, detail=str(e))
    
    async def destroy(self, id: int) -> Dict[str, Any]:
        """
        ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤
        DELETE /{{id}}
        """
        return {{
            "status": "success",
            "data": {{
                "id": id,
                "controller": "{name}",
                "deleted_at": "{datetime.now().isoformat()}"
            }},
            "message": f"Resource {{id}} deleted successfully"
        }}'''

        if controller_type.lower() == "gradio":
            controller_content += f'''
    
    def gradio_process(self, input_text: str) -> str:
        """
        Gradio å‡¦ç†é–¢æ•°
        """
        try:
            # ã‚«ã‚¹ã‚¿ãƒ å‡¦ç†ã‚’ã“ã“ã«å®Ÿè£…
            processed_result = f"{{self.__class__.__name__}} processed: {{input_text}}"
            return processed_result
        except Exception as e:
            logger.error(f"Gradio processing error: {{e}}")
            return f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {{e}}"'''

        controller_content += f'''

# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
# {name.lower()}_instance = {name}()
# router = {name.lower()}_instance.router  # FastAPIç”¨
'''
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        controller_path.parent.mkdir(parents=True, exist_ok=True)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        with open(controller_path, 'w', encoding='utf-8') as f:
            f.write(controller_content)
            
        print(f"âœ… {controller_type.upper()} Controller created: {controller_path}")
        print(f"ğŸ“ Location: {controller_path.relative_to(self.project_root)}")
        print(f"ğŸ¯ Type: {controller_type.upper()} (Django + FastAPI + Gradio compatible)")
        return True

class ServeCommand(ArtisanCommand):
    """é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, port=8000, host="0.0.0.0", *args, **kwargs):
        import subprocess
        print(f"ğŸš€ Starting development server on {host}:{port}")
        try:
            subprocess.run([
                "uvicorn", 
                "core.app:app", 
                "--host", str(host), 
                "--port", str(port), 
                "--reload"
            ])
        except KeyboardInterrupt:
            print("\nğŸ‘‹ Server stopped")

class ListRoutesCommand(ArtisanCommand):
    """ãƒ«ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤ºã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, *args, **kwargs):
        print("ğŸ›£ï¸  Application Routes:")
        print("+" + "-" * 50 + "+")
        print("| Method | URI | Controller |")
        print("+" + "-" * 50 + "+")
        
        # ãƒ«ãƒ¼ãƒˆæƒ…å ±ã‚’å‹•çš„ã«å–å¾—ï¼ˆå®Ÿè£…ãŒå¿…è¦ï¼‰
        routes = [
            ("GET", "/", "HomeController@index"),
            ("GET", "/api/health", "HealthController@check"),
        ]
        
        for method, uri, controller in routes:
            print(f"| {method:<6} | {uri:<15} | {controller:<20} |")
        
        print("+" + "-" * 50 + "+")

class ProjectInfoCommand(ArtisanCommand):
    """ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤ºã‚³ãƒãƒ³ãƒ‰"""
    
    def handle(self, *args, **kwargs):
        print("ğŸ—ï¸  Laravelæ§‹é€ å¯¾å¿œ Django+FastAPI+Gradio ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ")
        print("=" * 60)
        print(f"ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ: {self.project_root}")
        print(f"ğŸš€ ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ: app.py (Hugging Face Spacesäº’æ›)")
        print(f"âš™ï¸  ASGIè¨­å®š: mysite/asgi.py")
        print(f"ğŸ”§ ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—: bootstrap/app.py")
        print()
        
        # Laravelæ§‹é€ ã®ç¢ºèª
        laravel_dirs = [
            "laravel_app/Http/Controllers/Api",
            "laravel_app/Http/Controllers/Web", 
            "laravel_app/Http/Controllers/Gradio",
            "laravel_app/Services",
            "laravel_app/Models",
            "laravel_app/Console",
            "routes",
            "bootstrap"
        ]
        
        print("ğŸ“‚ Laravelæ§‹é€ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:")
        for directory in laravel_dirs:
            dir_path = self.project_root / directory
            status = "âœ…" if dir_path.exists() else "âŒ"
            print(f"   {status} {directory}")
        
        print()
        print("ğŸ”— ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆè¨­å®š:")
        print("   â€¢ Hugging Face Spaces: app.py")
        print("   â€¢ ASGI ã‚µãƒ¼ãƒãƒ¼: app:app")
        print("   â€¢ Django ASGI: mysite.asgi:app")
        print("   â€¢ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼: python bootstrap/app.py")
        print()
        
        # Laravelé¢¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç¢ºèª
        routes_files = [
            "routes/web.py",
            "routes/api.py", 
            "routes/polls.py",
            "routes/hybrid.py",
            "routes/laravel_routes.py"
        ]
        
        print("ğŸ”— Laravelé¢¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:")
        for route_file in routes_files:
            route_path = self.project_root / route_file
            status = "âœ…" if route_path.exists() else "âŒ"
            print(f"   {status} {route_file}")
        
        print()
        print("ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:")
        print("   â€¢ / - Web Routes (Laravelé¢¨)")
        print("   â€¢ /api/v1/ - API Routes (Laravelé¢¨)")
        print("   â€¢ /api/polls/ - Polls API")
        print("   â€¢ /hybrid/ - Hybrid Routes")
        print("   â€¢ /django/admin/ - Djangoç®¡ç†ç”»é¢")

class GradioTestCommand(ArtisanCommand):
    """Gradioæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰"""
    
    def __init__(self):
        super().__init__()
        self.base_url = "http://localhost:7860"
        self.gradio_functions = self._discover_gradio_functions()
    
    def _discover_gradio_functions(self):
        """controllers/ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰Gradioæ©Ÿèƒ½ã‚’è‡ªå‹•ç™ºè¦‹"""
        gradio_functions = {}
        controllers_path = self.project_root / "controllers"
        
        if not controllers_path.exists():
            return gradio_functions
            
        for item in controllers_path.iterdir():
            if item.is_dir() and item.name.startswith("gra_"):
                # gra_01_chat -> chat
                function_name = item.name.split("_", 2)[-1] if "_" in item.name else item.name
                gradio_functions[function_name] = {
                    "path": item,
                    "name": function_name,
                    "directory": item.name
                }
        
        return gradio_functions
    
    def handle(self, function_name=None, verbose=False, fix=False, *args, **kwargs):
        """Gradioãƒ†ã‚¹ãƒˆã®ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
        print("ğŸ§ª Gradioæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹...")
        print(f"ğŸ“¡ ãƒ†ã‚¹ãƒˆå¯¾è±¡URL: {self.base_url}")
        print("=" * 50)
        
        if function_name:
            # å€‹åˆ¥æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
            result = self._test_single_function(function_name, verbose, fix)
            return result
        else:
            # å…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
            return self._test_all_functions(verbose, fix)
    
    def _test_single_function(self, function_name, verbose=False, fix=False):
        """å˜ä¸€Gradioæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
        if function_name not in self.gradio_functions:
            print(f"âŒ æ©Ÿèƒ½ '{function_name}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            print(f"ğŸ” åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½: {list(self.gradio_functions.keys())}")
            return False
            
        function_info = self.gradio_functions[function_name]
        print(f"ğŸ§ª {function_name} æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆä¸­...")
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        result = self._run_gradio_test(function_info, verbose)
        
        if not result and fix:
            print(f"ğŸ”§ {function_name} ã®è‡ªå‹•ä¿®æ­£ã‚’è©¦è¡Œä¸­...")
            self._attempt_fix(function_info)
            
        return result
    
    def _test_all_functions(self, verbose=False, fix=False):
        """å…¨Gradioæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
        results = {}
        total_functions = len(self.gradio_functions)
        passed_functions = 0
        
        for function_name, function_info in self.gradio_functions.items():
            print(f"ğŸ§ª {function_name} æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆä¸­...")
            result = self._run_gradio_test(function_info, verbose)
            results[function_name] = result
            
            if result:
                passed_functions += 1
            elif fix: