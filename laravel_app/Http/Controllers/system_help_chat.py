import gradio as gr
from mysite.libs.utilities import completion
import os
import json

def get_feature_details():
    """å„æ©Ÿèƒ½ã®è©³ç´°æƒ…å ±"""
    return {
        "ã‚¹ã‚¿ãƒ¼ãƒˆ": {
            "åˆå¿ƒè€…ã‚¬ã‚¤ãƒ‰": {
                "èª¬æ˜": "ã‚·ã‚¹ãƒ†ãƒ ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã‚’å­¦ã¹ã‚‹ã‚¬ã‚¤ãƒ‰",
                "ä½¿ã„æ–¹": "1. ã‚¬ã‚¤ãƒ‰ã‚’é–‹ã â†’ 2. ã‚¹ãƒ†ãƒƒãƒ—ã«å¾“ã† â†’ 3. å®Ÿè·µã—ã¦ã¿ã‚‹",
                "å ´æ‰€": "ğŸš€ ã¯ã˜ã‚ã‚‹ ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "ã€ŒğŸš€ ã¯ã˜ã‚ã‚‹ã€ã‚¿ãƒ–ã‹ã‚‰ã€Œåˆå¿ƒè€…ã‚¬ã‚¤ãƒ‰ã€ã‚’é¸æŠ"
            }
        },
        "AIä½œæˆ": {
            "ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç”Ÿæˆ": {
                "èª¬æ˜": "è‡ªç„¶è¨€èªã®ä»•æ§˜æ›¸ã‹ã‚‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆ",
                "ä½¿ã„æ–¹": "1. è¦ä»¶ã‚’å…¥åŠ› â†’ 2. è¨€èªé¸æŠ â†’ 3. ç”Ÿæˆå®Ÿè¡Œ",
                "å ´æ‰€": "ğŸ¤– AIä½œæˆ ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "ã€Œä»•æ§˜æ›¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€æ¬„ã«è¦ä»¶ã‚’è¨˜è¿°"
            },
            "GitHub Issueä½œæˆ": {
                "èª¬æ˜": "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Issueã‚’è‡ªå‹•ç”Ÿæˆãƒ»æŠ•ç¨¿",
                "ä½¿ã„æ–¹": "1. Issueå†…å®¹å…¥åŠ› â†’ 2. ãƒ©ãƒ™ãƒ«é¸æŠ â†’ 3. ä½œæˆå®Ÿè¡Œ",
                "å ´æ‰€": "ğŸ¤– AIä½œæˆ ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "Issueå†…å®¹ã‚’è¨˜è¿°ã—ã¦ã€Œä½œæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™"
            },
            "RPAè‡ªå‹•åŒ–": {
                "èª¬æ˜": "Webãƒšãƒ¼ã‚¸ã®æ“ä½œã‚’è‡ªå‹•åŒ–ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ",
                "ä½¿ã„æ–¹": "1. å¯¾è±¡ã‚µã‚¤ãƒˆæŒ‡å®š â†’ 2. æ“ä½œæ‰‹é †è¨­å®š â†’ 3. è‡ªå‹•å®Ÿè¡Œ",
                "å ´æ‰€": "ğŸ¤– AIä½œæˆ ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "ã€ŒRPAè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã€ã‹ã‚‰æ“ä½œã‚’è¨­å®š"
            }
        },
        "ãƒãƒ£ãƒƒãƒˆ": {
            "AIãƒãƒ£ãƒƒãƒˆ": {
                "èª¬æ˜": "æ±ç”¨çš„ãªAIå¯¾è©±ã‚·ã‚¹ãƒ†ãƒ ",
                "ä½¿ã„æ–¹": "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã™ã‚‹ã ã‘",
                "å ´æ‰€": "ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã«è³ªå•ã‚’å…¥åŠ›"
            },
            "OpenInterpreter": {
                "èª¬æ˜": "ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œæ©Ÿèƒ½ä»˜ãã®é«˜åº¦ãªAIãƒãƒ£ãƒƒãƒˆ",
                "ä½¿ã„æ–¹": "1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› â†’ 2. ã‚³ãƒ¼ãƒ‰ç”Ÿæˆä¾é ¼ â†’ 3. å®Ÿè¡Œç¢ºèª",
                "å ´æ‰€": "ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼å¾Œã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°é–¢é€£ã®è³ªå•"
            }
        },
        "æ–‡æ›¸ä½œæˆ": {
            "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ": {
                "èª¬æ˜": "æŠ€è¡“æ–‡æ›¸ã‚„ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆ",
                "ä½¿ã„æ–¹": "1. æ–‡æ›¸ã‚¿ã‚¤ãƒ—é¸æŠ â†’ 2. å†…å®¹æŒ‡å®š â†’ 3. ç”Ÿæˆå®Ÿè¡Œ",
                "å ´æ‰€": "ğŸ“ æ–‡æ›¸ä½œæˆ ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "æ–‡æ›¸ã®ç¨®é¡ã¨å†…å®¹ã‚’æŒ‡å®šã—ã¦ç”Ÿæˆ"
            },
            "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†": {
                "èª¬æ˜": "AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜ãƒ»ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ",
                "ä½¿ã„æ–¹": "1. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç™»éŒ² â†’ 2. ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ â†’ 3. æ¤œç´¢ãƒ»åˆ©ç”¨",
                "å ´æ‰€": "ğŸ“ æ–‡æ›¸ä½œæˆ ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠãƒ»ç·¨é›†"
            }
        },
        "ç®¡ç†": {
            "çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰": {
                "èª¬æ˜": "ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®çŠ¶æ³ã‚’ä¸€å…ƒç®¡ç†",
                "ä½¿ã„æ–¹": "å„ç¨®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚„ãƒ­ã‚°ã‚’ç¢ºèª",
                "å ´æ‰€": "ğŸ“Š ç®¡ç† ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å„é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯"
            }
        },
        "ãã®ä»–": {
            "ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†": {
                "èª¬æ˜": "ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ç®¡ç†",
                "ä½¿ã„æ–¹": "1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ â†’ 2. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ 3. å‡¦ç†å®Ÿè¡Œ",
                "å ´æ‰€": "ğŸ”§ ãã®ä»– ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯é¸æŠ"
            },
            "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹": {
                "èª¬æ˜": "ãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²ãƒ»æ¤œç´¢ãƒ»ç·¨é›†æ©Ÿèƒ½",
                "ä½¿ã„æ–¹": "1. ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ â†’ 2. ãƒ‡ãƒ¼ã‚¿æ“ä½œ â†’ 3. ä¿å­˜",
                "å ´æ‰€": "ğŸ”§ ãã®ä»– ã‚¿ãƒ–",
                "å®Ÿè¡Œæ–¹æ³•": "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ç”»é¢ã‹ã‚‰æ“ä½œ"
            }
        }
    }

def search_feature_help(query):
    """æ©Ÿèƒ½ã®ãƒ˜ãƒ«ãƒ—ã‚’æ¤œç´¢"""
    details = get_feature_details()
    results = []
    
    query_lower = query.lower()
    
    for category, features in details.items():
        for feature_name, feature_info in features.items():
            # æ©Ÿèƒ½åã€èª¬æ˜ã€ä½¿ã„æ–¹ã§æ¤œç´¢
            searchable_text = f"{feature_name} {feature_info['èª¬æ˜']} {feature_info['ä½¿ã„æ–¹']}".lower()
            
            if query_lower in searchable_text:
                result = f"## ğŸ¯ {feature_name}\n\n"
                result += f"**ğŸ“ å ´æ‰€**: {feature_info['å ´æ‰€']}\n\n"
                result += f"**ğŸ“ èª¬æ˜**: {feature_info['èª¬æ˜']}\n\n"
                result += f"**ğŸš€ ä½¿ã„æ–¹**: {feature_info['ä½¿ã„æ–¹']}\n\n"
                result += f"**â–¶ï¸ å®Ÿè¡Œæ–¹æ³•**: {feature_info['å®Ÿè¡Œæ–¹æ³•']}\n\n"
                result += "---\n\n"
                results.append(result)
    
    if results:
        return "".join(results)
    else:
        return f"ã€Œ{query}ã€ã«é–¢ã™ã‚‹æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„ï¼š\n- ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã€ã‚³ãƒ¼ãƒ‰ã€ç”Ÿæˆ\n- ãƒãƒ£ãƒƒãƒˆã€AIã€å¯¾è©±\n- ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ç®¡ç†\n- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€æ–‡æ›¸ã€ä½œæˆ"

def enhanced_help_chat(message, history):
    """ãƒ˜ãƒ«ãƒ—ç‰¹åŒ–å‹ãƒãƒ£ãƒƒãƒˆ"""
    if any(keyword in message.lower() for keyword in ['æ©Ÿèƒ½', 'ä½¿ã„æ–¹', 'ãƒ˜ãƒ«ãƒ—', 'help', 'æ–¹æ³•', 'ã‚„ã‚Šæ–¹']):
        return search_feature_help(message)
    
    # ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’å«ã‚ã¦AIã«è³ªå•
    system_prompt = "ã‚ãªãŸã¯ AI-Humanå”åƒé–‹ç™ºã‚·ã‚¹ãƒ†ãƒ ã®ãƒ˜ãƒ«ãƒ—ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ã€ã‚·ã‚¹ãƒ†ãƒ ã®æ©Ÿèƒ½ã®ä½¿ã„æ–¹ã‚’å…·ä½“çš„ã§åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
    enhanced_message = f"{system_prompt}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•: {message}"
    
    return completion(enhanced_message, history)

# CSS for better styling
help_css = """
.help-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 20px;
    color: white;
    margin: 10px 0;
}
.feature-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}
.quick-help {
    background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
    border-radius: 10px;
    padding: 15px;
    color: white;
    margin: 10px 0;
}
"""

with gr.Blocks(css=help_css, title="ğŸ†˜ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ãƒ—") as gradio_interface:
    gr.Markdown("# ğŸ†˜ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ãƒ—ãƒ»æ©Ÿèƒ½ã‚¬ã‚¤ãƒ‰")
    gr.Markdown("### ğŸ’¡ æ©Ÿèƒ½ã®ä½¿ã„æ–¹ã‚’è©³ã—ãèª¬æ˜ã—ã¾ã™")
    
    with gr.Row():
        with gr.Column(scale=2):
            chatbot = gr.Chatbot(
                height=500,
                placeholder="ğŸ†˜ æ©Ÿèƒ½ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ï¼\n\nä¾‹ï¼š\n- ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ç”Ÿæˆã®ä½¿ã„æ–¹ã€\n- ã€ŒGitHub Issueã®ä½œã‚Šæ–¹ã€\n- ã€Œãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†æ©Ÿèƒ½ã«ã¤ã„ã¦ã€",
                label="ãƒ˜ãƒ«ãƒ—ãƒãƒ£ãƒƒãƒˆ"
            )
            
            msg = gr.Textbox(
                placeholder="ä½¿ã„æ–¹ã‚’çŸ¥ã‚ŠãŸã„æ©Ÿèƒ½åã‚„æ“ä½œã‚’å…¥åŠ›...",
                label="è³ªå•",
                lines=2
            )
            
            with gr.Row():
                submit_btn = gr.Button("è³ªå•ã™ã‚‹", variant="primary")
                clear_btn = gr.Button("ã‚¯ãƒªã‚¢")
        
        with gr.Column(scale=1):
            with gr.Group():
                gr.Markdown("### ğŸ” ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢")
                
                search_query = gr.Textbox(
                    placeholder="æ©Ÿèƒ½åã§æ¤œç´¢...",
                    label="æ©Ÿèƒ½æ¤œç´¢"
                )
                search_btn = gr.Button("æ¤œç´¢", variant="secondary")
                search_result = gr.Markdown("")
            
            with gr.Group():
                gr.Markdown("### ğŸ“š äººæ°—ã®è³ªå•")
                gr.Markdown("""
                â€¢ **ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç”Ÿæˆã®ä½¿ã„æ–¹**
                â€¢ **ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®ç¨®é¡**  
                â€¢ **ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ–¹æ³•**
                â€¢ **GitHub Issueä½œæˆæ‰‹é †**
                â€¢ **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ“ä½œæ–¹æ³•**
                """)
    
    # ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
    def respond(message, chat_history):
        bot_message = enhanced_help_chat(message, chat_history)
        chat_history.append((message, bot_message))
        return "", chat_history
    
    def search_and_display(query):
        if query.strip():
            return search_feature_help(query)
        return "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
    
    # ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    msg.submit(respond, [msg, chatbot], [msg, chatbot])
    submit_btn.click(respond, [msg, chatbot], [msg, chatbot])
    clear_btn.click(lambda: ([], ""), outputs=[chatbot, msg])
    
    search_btn.click(search_and_display, inputs=search_query, outputs=search_result)
    search_query.submit(search_and_display, inputs=search_query, outputs=search_result)
    
    # ã‚ˆãã‚ã‚‹è³ªå•ã®ä¾‹
    gr.Examples(
        examples=[
            ["ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç”Ÿæˆæ©Ÿèƒ½ã®è©³ã—ã„ä½¿ã„æ–¹ã‚’æ•™ãˆã¦"],
            ["GitHub Issueã‚’ä½œæˆã™ã‚‹æ‰‹é †ã¯ï¼Ÿ"],
            ["ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ï¼Ÿ"],
            ["ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®é•ã„ã‚’èª¬æ˜ã—ã¦"],
            ["ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®æ–¹æ³•ã¯ï¼Ÿ"],
            ["RPAè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®ä½¿ã„æ–¹"]
        ],
        inputs=msg,
        label="ğŸ’¡ ã‚ˆãã‚ã‚‹è³ªå•"
    )

# è‡ªå‹•æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ç”¨ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿  
interface_title = "ğŸ†˜ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ãƒ—"
interface_description = "æ©Ÿèƒ½ã®ä½¿ã„æ–¹ã‚’è©³ã—ãæ¡ˆå†…ã™ã‚‹ãƒ˜ãƒ«ãƒ—ã‚·ã‚¹ãƒ†ãƒ "
