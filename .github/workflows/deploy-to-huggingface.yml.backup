name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—
        lfs: true  # Git LFS ã‚µãƒãƒ¼ãƒˆ
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub
        
    - name: Configure Git for Hugging Face
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
    
    - name: Setup Hugging Face Token
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        # Hugging Face Hubã«ãƒ­ã‚°ã‚¤ãƒ³
        python -c "
        from huggingface_hub import login
        import os
        token = os.environ.get('HF_TOKEN')
        if token:
            login(token=token)
            print('âœ… Hugging Face login successful')
        else:
            print('âŒ HF_TOKEN not found in secrets')
            exit(1)
        "
    
    - name: Clone Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        # Hugging Face Spaceã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
        git clone https://huggingface.co/spaces/kenken999/fastapi_django_main_live hf_space
        cd hf_space
        
        # èªè¨¼æƒ…å ±ã‚’è¨­å®š
        git remote set-url origin https://oauth2:$HF_TOKEN@huggingface.co/spaces/kenken999/fastapi_django_main_live
    
    - name: Copy files and update Space
      run: |
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
        echo "ðŸ“‚ Copying updated files..."
        
        # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
        if [ -f "app.py" ]; then
          cp app.py hf_space/
          echo "âœ… Copied app.py"
        fi
        
        # requirements.txt ã‚’ã‚³ãƒ”ãƒ¼
        if [ -f "requirements.txt" ]; then
          cp requirements.txt hf_space/
          echo "âœ… Copied requirements.txt"
        fi
        
        # Dockerfile ã‚’ã‚³ãƒ”ãƒ¼
        if [ -f "Dockerfile" ]; then
          cp Dockerfile hf_space/
          echo "âœ… Copied Dockerfile"
        fi
        
        # .env.example ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
        if [ -f ".env.example" ]; then
          cp .env.example hf_space/
          echo "âœ… Copied .env.example"
        fi
        
        # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚³ãƒ”ãƒ¼
        echo "ðŸ“ Copying project directories..."
        
        # controllers ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆGradioã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰
        if [ -d "controllers" ]; then
          cp -r controllers hf_space/
          echo "âœ… Copied controllers/ directory"
        fi
        
        # mysite ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆDjangoã‚³ã‚¢ï¼‰
        if [ -d "mysite" ]; then
          cp -r mysite hf_space/
          echo "âœ… Copied mysite/ directory"
        fi
        
        # templates ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        if [ -d "templates" ]; then
          cp -r templates hf_space/
          echo "âœ… Copied templates/ directory"
        fi
        
        # static ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        if [ -d "static" ]; then
          cp -r static hf_space/
          echo "âœ… Copied static/ directory"
        fi
        
        # README.md ã‚’æ›´æ–°
        echo "ðŸ“ Updating README.md with deployment info..."
        cat > hf_space/README.md << 'EOF'
        ---
        title: FastAPI Django Main Live
        emoji: ðŸš€
        colorFrom: blue
        colorTo: purple
        sdk: docker
        pinned: false
        license: mit
        app_port: 7860
        ---

        # FastAPI Django Main Live - Hugging Face Spaces

        ðŸš€ **AI-Driven Auto-Generation System with Gradio Interfaces**

        ## ðŸŒŸ ç‰¹å¾´

        - âœ… **GitHub Actionsè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤**
        - ðŸ¤– **AIé§†å‹•ã®è‡ªå‹•ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ç”Ÿæˆ**
        - ðŸ“Š **ãƒžãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ï¼ˆç”»åƒâ†’UIç”Ÿæˆï¼‰**
        - âš¡ **8-9å€‹ã®Gradioã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è‡ªå‹•çµ±åˆ**
        - ðŸŽ¨ **å‹•çš„UIç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ **
        - ðŸŒ **Hugging Face Spaceså®Œå…¨å¯¾å¿œ**

        ## ðŸš€ ã‚¢ã‚¯ã‚»ã‚¹

        ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ï¼š

        - `/` - ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        - `/gradio` - çµ±åˆGradioã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
        - Auto-detected interfaces from controllers/

        ## ðŸ”„ è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

        ã“ã®ã‚¹ãƒšãƒ¼ã‚¹ã¯GitHub Actionsã§è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ï¼š
        - `main`ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
        - æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
        - AIé§†å‹•ã‚·ã‚¹ãƒ†ãƒ ã®æœ€æ–°ç‰ˆã‚’å¸¸ã«åæ˜ 

        ## ðŸ“¡ æœ€çµ‚æ›´æ–°

        Last deployed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        EOF
    
    - name: Create or update app.py for Hugging Face Spaces
      run: |
        # æ—¢å­˜ã®app.pyã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆå¿…è¦ã«å¿œã˜ã¦Hugging Faceç”¨ã«èª¿æ•´ï¼‰
        echo "âœ… Using existing app.py for Hugging Face Spaces"
        
        # ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        cat > hf_space/.env.example << 'EOF'
        # Hugging Face Spaces Environment Variables Template
        # Copy this to .env and fill in your actual values
        
        # API Keys
        GROQ_API_KEY=your_groq_api_key_here
        HF_TOKEN=your_huggingface_token_here
        
        # Gradio Configuration
        GRADIO_THEME=huggingface
        GRADIO_SERVER_NAME=0.0.0.0
        GRADIO_NUM_PORTS=1
        
        # System Configuration
        PYTHONUNBUFFERED=1
        EOF
    
    - name: Update requirements.txt for Hugging Face Spaces
      run: |
        # æ—¢å­˜ã®requirements.txtã‚’ãƒ™ãƒ¼ã‚¹ã«ã€Hugging Face Spacesç”¨ã«èª¿æ•´
        if [ -f "requirements.txt" ]; then
          echo "âœ… Using existing requirements.txt"
        else
          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®requirements.txtã‚’ä½œæˆ
          cat > hf_space/requirements.txt << 'EOF'
        fastapi==0.109.2
        uvicorn[standard]==0.24.0
        gradio>=3.0.0
        python-dotenv>=0.19.0
        python-multipart>=0.0.6
        jinja2>=3.1.2
        groq>=0.4.0
        Pillow>=9.0.0
        aiofiles>=0.8.0
        EOF
          echo "âœ… Created fallback requirements.txt for Hugging Face Spaces"
        fi
    
    - name: Create Dockerfile for Hugging Face Spaces
      run: |
        # æ—¢å­˜ã®Dockerfileã‚’ãƒ™ãƒ¼ã‚¹ã«ä½¿ç”¨
        if [ -f "Dockerfile" ]; then
          echo "âœ… Using existing Dockerfile"
          # Hugging Face Spacesç”¨ã«ãƒãƒ¼ãƒˆèª¿æ•´ãŒå¿…è¦ãªå ´åˆã®ã¿ä¿®æ­£
          if ! grep -q "EXPOSE 7860" hf_space/Dockerfile; then
            echo "ðŸ“ Adjusting Dockerfile for Hugging Face Spaces port..."
            sed -i 's/EXPOSE [0-9]*/EXPOSE 7860/' hf_space/Dockerfile 2>/dev/null || true
          fi
        else
          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®Dockerfileã‚’ä½œæˆ
          cat > hf_space/Dockerfile << 'EOF'
        FROM python:3.11-slim

        WORKDIR /code

        # ã‚·ã‚¹ãƒ†ãƒ ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        RUN apt-get update && apt-get install -y \
            gcc \
            && rm -rf /var/lib/apt/lists/*

        # Pythonã®ä¾å­˜é–¢ä¿‚ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        COPY ./requirements.txt /code/requirements.txt
        RUN pip install --no-cache-dir --upgrade -r /code/requirements.txt

        # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
        COPY . /code/

        # ãƒãƒ¼ãƒˆ7860ã‚’å…¬é–‹ï¼ˆHugging Face Spacesæ¨™æº–ï¼‰
        EXPOSE 7860

        # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
        CMD ["python", "app.py"]
        EOF
          echo "âœ… Created fallback Dockerfile for Hugging Face Spaces"
        fi
    
    - name: Deploy to Hugging Face Spaces
      run: |
        cd hf_space
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [ -n "$(git status --porcelain)" ]; then
          echo "ðŸ“¤ Changes detected, deploying to Hugging Face Spaces..."
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add .
          git commit -m "ðŸš€ Auto-deploy from GitHub Actions $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          âœ… Features updated:
          - FastAPI Django Main Live (Latest)
          - AI-driven auto-generation system
          - Multiple Gradio interfaces auto-detection
          - Multimodal image-to-UI generation
          - Enhanced dynamic UI generation
          
          ðŸ¤– Deployed via GitHub Actions"
          
          # Hugging Face Spacesã«ãƒ—ãƒƒã‚·ãƒ¥
          git push origin main
          
          echo "âœ… Successfully deployed to Hugging Face Spaces!"
          echo "ðŸŒ Check your space at: https://huggingface.co/spaces/kenken999/fastapi_django_main_live"
        else
          echo "â„¹ï¸  No changes detected, skipping deployment"
        fi
    
    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "- **Target**: Hugging Face Spaces" >> $GITHUB_STEP_SUMMARY
        echo "- **Space URL**: https://huggingface.co/spaces/kenken999/fastapi_django_main_live" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Features**: FastAPI Django Main Live with AI-driven interfaces" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š AI-Driven System Features" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Auto-detection of Gradio interfaces" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Multimodal image-to-UI generation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dynamic React/Vue.js code generation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Weather forecast AI integration" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Frontend generator with smart analysis" >> $GITHUB_STEP_SUMMARY
